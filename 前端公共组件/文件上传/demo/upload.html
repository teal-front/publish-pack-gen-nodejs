<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link rel="stylesheet" type="text/css" href="http://res.hzins.com/web/public/webuploader/webuploader.css">
<style>
body,ul,li,p { padding:0; margin: 0;}
ul, li { list-style: none;}
.uploader { border: dashed 5px #ccc; margin:50px; width: 500px; padding:10px;  text-align: center;}
.item { background: #eee; padding:10px; margin-bottom: 10px; }
.uploader-list { height: 300px; overflow: auto;}
.btn-picker, .btn-default { float: left;;}
.btn-default {
    background: #e0e0e0;
    border: 0;
    padding:12px 20px;
    border-radius: 3px;
    margin-left: 10px;
}

.btn-default:hover { background: #ccc;}
</style>
</head>

<body>

<div id="uploader" class="uploader">
    
    <ul id="file-list" class="uploader-list">
    </ul>

    <div class="btns">
        <span id="picker" class="btn-picker">选择文件</span>
        <button id="doUplaod" class="btn btn-default">开始上传</button>
    </div>

    <div style="clear:both;"></div>

</div>

<script type="text/javascript" src="http://res.hzins.com/long/public/framework/jquery/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="http://res.hzins.com/web/public/webuploader/webuploader.js"></script>
<script type="text/javascript">
(function() {
var blockUplated = {};
var gChecked = false; // 标记，批量上传时只查询一次服务器分片文件

// hook
WebUploader.Uploader.register({
    // 分片上传前的处理
    'before-send': function(block) {
        var deferred = WebUploader.Base.Deferred();

        // 服务器所有分片都存在, 重传最后一片触发合并操作
        if ( block.chunks >0 && block.chunks === block.chunk && isAllPartUploaded( block ) ) {
            deferred.resolve();
        }
        // 如果已经上传，则忽略
        else if ( isUploaded(block) ) {
            deferred.reject();
        }
        else {
            deferred.resolve();
        }

        return deferred.promise();
    },
    // 文件上传前的处理
    'before-send-file': function( file ) {
        var me = this,
            owner = this.owner,
            server = me.options.server,
            deferred = WebUploader.Deferred();

        if (file.md5) {// 文件已经校验过
            md5Done(file.md5);
        }
        else {
            owner.md5File( file.source )
            .fail(function() {
                deferred.reject();
            })
            .then(md5Done);
        }

        $('#'+file.id).find(' .state').html('(校验中..)');

        function md5Done( md5 ) {
            file.md5 = md5;

            if ( !gChecked ) {
                gChecked = true;// 一次上传多个文件时， 只检查一次，直到再次点击上传
                $.ajax('/checkfile', {
                    dataType: 'json',
                    cache: false,
                    data: {
                        // md5: md5
                    },
                    success: function( re ) {
                        /*if ( re.exist ) {
                            owner.skipFile( file ); // 跳过文件
                        }*/
                        blockUplated = re;
                        deferred.resolve(); // 延迟对象resolve，则继续上传流程
                    }
                });
            }
            else {
                deferred.resolve();
            }
        }

        return deferred.promise();
    }
});

// uploader配置
var uploader = WebUploader.create({
    swf: '/web/public/Uploader.swf', // 跨域无效？
    server: '/upload',
    pick: '#picker', // 选择文件的按钮。可选。内部根据当前运行是创建，可能是input元素，也可能是flash.
    resize: false,// 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
    chunked: true, // 是否分片
    chunkSize: 52428*100, // 分片大小， 5M

    dnd: '#uploader' // 拖拽
});

// 当有文件被添加进队列的时候
uploader.on( 'fileQueued', function( file ) {
    $('#file-list').append( '<li id="' + file.id + '" class="item">' +
        '<span class="info">' + file.name + '</span>' +
        '<span class="state">(等待上传...)</span>' +
    '</li>' );
})
.on( 'uploadBeforeSend', function( a, data, c ) {
    data.md5 = a.file.md5;
})
.on( 'uploadSuccess', function( file, re ) {
    $('#'+file.id).find(' .state').html('(完成)');
})
.on( 'uploadError', function( file, err ) {
    $('#'+file.id).find(' .state').html('(上传错误，<span file-id="'+file.id+'" style="color:red; cursor:pointer" class="js_retry">重试</span>)');
})
.on( 'uploadProgress', function( file, percent ) {
    $('#'+file.id).find(' .state').html('('+ Math.round(percent*100)+'%)');
});

// 开始上传、重试
$('body').on('click', '#doUplaod', function () {
    gChecked = false;
    uploader.upload();
})
.on('click', '.js_retry', function(){
    var id = $(this).attr('file-id');
    $.each( uploader.getFiles(), function( i, file ) {
        if ( file.id === id ) {
            gChecked = false;
            uploader.retry(file);
        }
    })
});

// 检查分片是否在服务器分片列表中
function isUploaded( block ) {
    return $.inArray( block.file.md5 + '-' + block.chunk + '.part', blockUplated ) > -1;
}

// 单个文件的所有分片都已经存在于服务器
function isAllPartUploaded( block ) {
    for ( var i = block.chunks; i>=0; i--) {
        if( !( $.inArray( block.file.md5 + '-' + block.chunk + '.part', blockUplated ) > -1 ) ) {
            return false;
        }
    }
    return true;
}

})();

</script>
</body>
</html>
