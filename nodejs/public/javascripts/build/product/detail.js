/**
 ** 
 ** www.huize.com; 
 ** Version:0.1.0;
 ** Last Updated:2016-08-09; 
 **
 **/
define(["jquery","underscore","exports","require","module","helper","layer","top-menu","animate-fly"],function($,a,b,c,d,e,f,g){"use strict";var h,i,j=20,k=20,l={isLogin:!1,renewalNum:"",isRenewal:!1,toolFloat:{},trialBox:{},init:function(a){this.trialBox=a,l.render.initTool(),e.cookie.getCookie("compareProducts").indexOf($("#planId").val()||$("#productId").val())>-1&&($("#addToCompare").addClass("hz-check-item-checked"),$("#addToCompare .hz-check-text").html("已加入对比")),"1"===$("#pcProductStatus").val(),l.actions.addHistoryPlan($("#planId").val()||$("#productId").val(),$("#productId").val()),l.actions.getProductStatus(),l.actions.replaceProduct();var b;if(b=e.url.getUrlVar("ep")){var c={};b=b.split("~"),b.forEach(function(a,b){var d=a.split("_")[0],e=a.split("_")[1];c[d]=e}),l.renewalNum=c.ins,l.isRenewal="1"===c.IsRenewal}l.render.combineProtect()},io:{},topMenu:{},render:{initTool:function(){requirejs(["share-panel","fix-float","fixed-tool-float"],function(a,b,c){new a({items:["sina","zone"],url:location.href,summary:$("#productName").val()+($("#productPlanName").html()||""),productId:$("#productId").val(),planId:$("#planId").val()||$("#productId").val()}),new b({el:$("#detialTab"),fixPanel:$("#detaTabLayout"),fixClass:"fixed-detail-tab-wrap"}),new b({el:$("#silderbar"),fixPanel:$("#detaTabLayout"),fixClass:"fixed-sidebar"});l.toolFloat=new c,l.actions.isFavorite(),l.actions.initAction()}),e.state.checkLogin(function(a){l.isLogin=a.result,l.isLogin?e.request.getJson({url:"/api/users/customer-service"},function(a){h=a.result,h.adviserInfoList&&h.adviserInfoList.length?($("#contactkefu").removeClass("fn-hide"),$("#onlinekefu").addClass("fn-hide"),$("#contactkefu").attr("href","http://kefu.hzins.com/chat?domain=hzins&businessType=Xm4FWr0dncw&referrer="+encodeURIComponent(window.location.href)+"&consultant="+h.adviserInfoList[0].employeeNo)):($("#onlinekefu").removeClass("fn-hide"),$("#onlinekefu").attr("href","http://kefu.hzins.com/chat?domain=hzins&businessType=Xm4FWr0dncw&referrer="+encodeURIComponent(window.location.href)))}):($("#onlinekefu").removeClass("fn-hide"),$("#onlinekefu").attr("href","http://kefu.hzins.com/chat?domain=hzins&businessType=Xm4FWr0dncw&referrer="+encodeURIComponent(window.location.href)))})},combineProtect:function(){var a,b,c,d=$("#protectArea li[trialitemid]");d.each(function(e){a=$(this),b=$(d[e+1]),c=e-1>=0?$(d[e-1]):null,a&&b&&a.attr("trialitemid")===b.attr("trialitemid")&&a.css("border-bottom","none"),a&&c&&a.attr("trialitemid")===c.attr("trialitemid")&&($("#protectArea .row01 div",a).hide(),$("#protectArea .row02 div",a).hide())})}},actions:{initAction:function(){var a=function(){var a=window.document.body.clientWidth||0;$("#detialTab").hasClass("fixed-detail-tab-wrap")&&1190>a?$("#detialTab .layout").width(a):$("#detialTab .layout").width(1190),$("#silderbar").hasClass("fixed-sidebar")&&1190>a?$("#silderbar").css("right","6px"):$("#silderbar").css("right","auto")};a(),$(window).scroll(function(){a()}),$("#favorite").bind("click",function(){l.isLogin?$("#favorite").hasClass("active")?f.confirm("<div class='pt45 pb45 tac'>确定取消该产品的收藏吗</div>",{btn:["取消","确定"],area:"530px",title:!1,btn1:function(a){f.close(a)},btn2:function(a){e.request.getCrossJson({url:"//i.huize.com/MyFavorite/Delete4Jsonp",data:{productProtectPlanId:$("#planId").val()||4776}},function(a){a.IsSuccess?(f.msg("取消成功"),$("#favorite").removeClass("active").find("span").text("收藏"),$("#favorite").find(".iconfont").html("&#xe741;")):f.msg("取消失败")})}}):e.request.getCrossJson({url:"//i.huize.com/MyFavorite/Add",data:{productProtectPlanId:$("#planId").val()||$("#productId").val(),isFavorite:!0}},function(a){a.IsSuccess?(f.msg("收藏成功"),$("#favorite").addClass("active").find("span").text("已收藏"),$("#favorite").find(".iconfont").html("&#xe744;")):f.msg("收藏失败")}):requirejs(["sign-float"],function(a){new a({returnUrl:location.href,showRegister:!0,callback:function(a){location.reload()}})})}),$("#addToCompare").bind("click",function(){if($(this).hasClass("hz-check-item-checked"))$(this).removeClass("hz-check-item-checked"),l.toolFloat.delcomparePro($("#planId").val()||$("#productId").val()),$("#addToCompare .hz-check-text").html("加入对比");else{if(l.toolFloat.getCompareCount()>=4)return void f.msg("对比数目最大不能超过4个");$(this).addClass("hz-check-item-checked"),$("#addToCompare .hz-check-text").html("已加入对比"),$("#fixedsidetool").css("right",0),$("#wrapToolMenu").css("left",0),l.actions.animateFly($(this),$("#compareCount"),function(){l.toolFloat.addcomparePro($("#planId").val()||$("#productId").val())})}}),$("a[addtoShopCar],a[insuredstart]").bind("click",function(a){if(!$(this).hasClass("hz-button-disabled")){var b=this,c=l.trialBox[$("#planId").val()||$("#productId").val()],d=[],g={},h=void 0!==$(b).attr("insuredstart");if(h&&"2"===$("#pcBuyType").val()){var k=$("#companyBuyUrl").val();return-1===k.indexOf("http://")&&(k="http://"+k),void e.page.openNewTag(k)}var m=function(){if(h&&1===i.orderStatus){i.failureTimeEnd.split("T")[1].split(":");f.confirm(i.notice.replace("#00:00#","<font color='red'>"+i.endHour+"</font>"),{btn:["看看同类产品","继续购买"],area:"530px",btn1:function(){e.page.openNewTag("/product/ins-"+$("#categoryId").val()+"-0-0")},btn2:function(){n()}})}else n()},n=function(){g.restrictRule={platform:"1",channel:1},g.genes=JSON.parse(c.getGenesString()).genes,g.productId=~~c.productId,g.planId=c.productPlanId,g.totalNum=1,g.inShoppingCart=!h,l.isRenewal&&(g.renewalInsureNum=l.renewalNum),d.push(g),e.request.postData2({url:"/api/insurance-slips",data:d},function(a){var c=a.result;if(!c)return void(h?f.msg(a.message||"创建投保单失败"):f.msg(a.message||"添加购物车失败"));var d=function(){c[0].insureNum&&(0===c[0].healthPosition?location.href="//is.huize.com/product/insure/health-inform?insuranceNum="+c[0].insureNum+"&planId="+c[0].planId:location.href="//is.huize.com/product/insure?insureNumber="+c[0].insureNum+"&DProtectPlanId="+g.planId)};if(l.isLogin)return void(h?e.state.checkLogin(function(a){l.isLogin=a.result,l.isLogin?d():requirejs(["sign-float"],function(a){new a({returnUrl:location.href,showRegister:!0,callback:function(a){d()}})})}):($("#fixedsidetool").css("right",0),$("#wrapToolMenu").css("left",0),l.actions.animateFly($(b),$("#showCarBtn"),function(){f.msg("加入购物车成功"),l.toolFloat.refreshShopCar()})));if(h)return void requirejs(["sign-float"],function(a){new a({returnUrl:location.href,showRegister:!0,callback:function(a){d()}})});var i=e.cookie.getCookie("InsureNums");return i.split(",").length===j?void f.alert("购物车数量达到上限，请先结算购物车中的产品",{btn:["去购物车"]},function(a){f.close(a),location.href="//is.huize.com/shopping-cart/"}):($(c).each(function(a,b){-1===i.indexOf(b.insureNum)&&(i?i=i+","+b.insureNum:i+=b.insureNum,e.cookie.setCookie("InsureNums",i,864e5,".huize.com"))}),$("#fixedsidetool").css("right",0),$("#wrapToolMenu").css("left",0),void l.actions.animateFly($(b),$("#showCarBtn"),function(){f.msg("加入购物车成功"),l.toolFloat.refreshShopCar()}))})};"undefined"!=typeof i||h?m():l.actions.getProductStatus(function(a){i=a.result,m()})}}),$("#recommendTableContent").delegate(".hz-button","click",function(){for(var a=$("div[data-tab='recommend-"+$(this).attr("dindex")+"'] ul li"),b=[],c=$(this),d=0;d<a.length;d++)$(a[d]).attr("planId")&&b.push({planId:$(a[d]).attr("planId"),productId:$(a[d]).attr("productId"),inShoppingCart:!0});e.request.postData2({url:"/api/insurance-slips",data:b},function(a){var b=a.result;if(!b)return void f.msg(a.message||"添加购物车失败");if(l.isLogin)return void l.actions.animateFly($(c),$("#showCarBtn"),function(){f.msg("加入购物车成功"),l.toolFloat.refreshShopCar()});var d=e.cookie.getCookie("InsureNums");return d.split(",").length===j?void f.alert("购物车数量达到上限，请先结算购物车中的产品",{btn:["去购物车"]},function(a){f.close(a),location.href="//is.huize.com/shopping-cart/"}):($(b).each(function(a,b){-1===d.indexOf(b.insureNum)&&(d?d=d+","+b.insureNum:d+=b.insureNum,e.cookie.setCookie("InsureNums",d,864e5,".huize.com"))}),void l.actions.animateFly($(c),$("#showCarBtn"),function(){f.msg("加入购物车成功"),l.toolFloat.refreshShopCar()}))})}),$("#planIdBox .primary-link").bind("click",l.actions.showPlansCompare)},replaceProduct:function(){var b=$("#pcProductStatus").val(),d=$("#pcReplaceId").val(),g=this;"2"===b&&d&&e.request.getJson({url:"/api/products/plans/"+d+"/similar"},function(b){b.result&&c(["require-text!/html/product/replace-product.html"],function(c){var d,e;$.each(b.result.restrictRules&&b.result.restrictRules.protectTrialItemList||[],function(){d=this.relateCoverageId,e=this,d&&$.each(b.result.restrictRules.restrictGenes,function(){this.protectItemId===~~d&&(this.defaultValue?e.fullPremium=this.defaultValue:this.dictionaryList&&this.dictionaryList.length>0&&(e.fullPremium=this.dictionaryList[0].value+g.getUnit(this.dictionaryList[0].unit)))})}),f.open({type:1,title:"系统提示",area:["860px"],content:a.template(c)({data:b.result})})})})},getProductStatus:function(a){e.request.getJson({url:"/api/products/"+$("#productId").val()+"/issuing-state"},function(a){i=a.result;var b=$("#pcProductStatus").val();if(2===i.orderStatus&&("2"===b||"0"===b)){var c=i.failureTimeEnd.split("T"),d=c[0].split("-"),f=c[1].split(":"),g=i.notice.replace("yyyy",d[0]).replace("MM",d[1]).replace("dd",d[2]).replace("HH",f[0]).replace("mm",f[1]).replace("#","<font color='red'>").replace("#","</font>").replace(/"/g,"");e.page.showSingleBtn(g,function(){e.page.openNewTag("/product/ins-"+$("#categoryId").val()+"-0-0")},"看看同类产品")}},function(a){})},showPlansCompare:function(){var b,d,g=[],h=[];$("#planIdBox a.filter-tag ").each(function(){b=$(this).data("productplanid"),d=$(this).html(),g.push(b),h.push({planId:b,planName:d})}),e.request.postData2({url:"/api/products/plans-comparison",data:g},function(b){c(["require-text!/html/product/plans-compara.html"],function(c){var d=l.actions.getPlansCompare(b.result,h),e=(f.open({type:1,closeBtn:1,area:["860px","500px"],shift:2,title:"计划对比",shadeClose:!0,content:a.template(c)({plans:h,keyList:d.list,itemIndex:d.count,gens:b.result})}),$("#planList").find(".hz-check-item-checked").length+1);6>e?$("#tabgen").width(800):$("#tabgen").width(160*e),$("#planList").delegate("div","click",function(){var a=$(this).attr("planId");$(this).toggleClass("hz-check-item-checked"),$("#tabgen td[planId="+a+"],#tabgen col[planId="+a+"],#tabgen col[planId="+a+"],#tabgen th[planId="+a+"]").toggleClass("fn-hide");var b=$("#planList").find(".hz-check-item-checked").length+1;6>b?$("#tabgen").width(800).find("col").attr("width",100/b+"%"):$("#tabgen").width(160*b).find("col").attr("width","160px")}),$("#planHead").delegate("th","click",function(){var a="",b=$(this).attr("planId");if($(this).hasClass("active"))a=$(".popover-content.fb",this).html(),$(this).html(a),$(this).removeClass("active"),$("#tabgen td[planId='"+b+"']").removeClass("active");else{if(a=$(this).html(),""===a)return;$(this).html('<div class="popover top"><div class="popover-content fb">'+a+'</div><div class="arrow"></div><div class="arrow2"></div></div>'),$(this).addClass("active"),$("#tabgen td[planId='"+b+"']").addClass("active")}}),$("#planHead th[planid='"+$("#planId").val()+"']").click()})})},favoriteAction:function(a){e.request.getCrossJson({url:a.url,data:{productProtectPlanId:$("#planId").val()||$("#productId").val(),isFavorite:!0}},function(a){a.IsSuccess?(f.msg("收藏成功"),$("#favorite").addClass("active").find("span").text("已收藏"),$("#favorite").find(".iconfont").html("&#xe744;")):f.msg("收藏失败")})},isFavorite:function(){e.request.getCrossJson({url:"//i.huize.com/MyFavorite/CheckProductPlanIsFavorite",data:{productProtectPlanId:$("#planId").val()||$("#productId").val()}},function(a){a.Data&&($("#favorite").addClass("active").find("span").text("已收藏"),$("#favorite").find(".iconfont").html("&#xe744;"))})},addHistoryPlan:function(a,b){var c=this;if(a){var d,f=e.cookie.getCookie("Product_History"),g=f.split(",");if(g.length>=k){var h=g[g.length-1];d=c.cookieStr(f,h.split(":")[1],h.split(":")[0],2),f=d}d=c.cookieStr(f,a,b,1),d&&d.length>0&&e.cookie.setCookie("Product_History",d,432e6,".huize.com")}},animateFly:function(a,b,c){var d="//img.huizecdn.com/hz/www/page/cart-flyer.png",e=$('<img class="u-flyer" src="'+d+'">').width(40).height(40),f=document.body.scrollTop||document.documentElement.scrollTop,g=a.offset().top-a.height()/2-f,h=a.offset().left+a.width()/2,i=b.offset().top+b.height()/2-f;e.fly({start:{left:h,top:g},end:{left:b.offset().left,top:i,width:0,height:0},onEnd:function(){"function"==typeof c&&c()}})},cookieStr:function(a,b,c,d){var e=a.split(","),f="";if(e=$.grep(e,function(a){return""!==a}),1===d){for(var g=0;g<e.length;g++)if(e[g]===c+":"+b||e[g].split(":")[0]===c+"")return f=e[g],e.splice(g,1),e.unshift(f),e.join(",");e.unshift(c+":"+b)}else for(var g=0;g<e.length;g++)if(e[g]===c+":"+b)return e.splice(g,1),e.join(",");return e.join(",")},getUnit:function(a){return{0:"",1:"份",2:"万元",3:"元",4:"0元",5:"00元",6:"000元",7:"岁",8:"年",9:"月",10:"天",11:"元/年"}[a]},getProtectItem:function(b,c){var d;return a.each(c,function(a,c){a.protectItemId===~~b&&(d=a)}),d||{}},getPlanValue:function(a,b,c){var d="",e="",f=this;if(a.subRestrictGeneList&&a.subRestrictGeneList.length>0){if(a.subRestrictGeneList[0].dictionaryList&&$.each(c.insureAreaList,function(){d+=this.provinceName,this.cityName&&(d=d+"-"+this.cityName),this.areaName&&(d=d+"-"+this.areaName),d+=","}),d)return d.length>100?d.substr(0,100).replace(/,$/,"")+"...":d}else if(a.dictionaryList&&a.dictionaryList.length>0&&"insurantJob"===a.key&&($(a.dictionaryList).each(function(){d=d+this.value+","}),d))return d.replace(/,$/,"");return e=b?"<p>"+b+"</p>":"",e+(a.defaultValue||a.fullPremium||a.premium&&(a.premium/100).toFixed(2)+f.getUnit(a.unit)||"")},getPlansCompare:function(b,c){var d={},e=0,f=this,g=[],h="",i=function(b,i,j){a.each(b,function(a){h=(a.key||a.name||a.trialItemId)+":"+a.name,a.display&&(d[h]?a.relateCoverageId?d[h][""+c[i].planId]=f.getProtectItem(a.relateCoverageId,j.restrictRuleOperList[0].restrictGenes).defaultValue:d[h][""+c[i].planId]=f.getPlanValue(a,d[h][""+c[i].planId],j):(d[h]={t:a.name},a.relateCoverageId?d[h][""+c[i].planId]=f.getProtectItem(a.relateCoverageId,j.restrictRuleOperList[0].restrictGenes).defaultValue:d[h][""+c[i].planId]=f.getPlanValue(a,d[h][""+c[i].planId],j),e+=1,g.push(d[h])))})};a.each(b,function(a,b){i(a.restrictRuleOperList[0].restrictGenes,b,a)}),a.each(b,function(a,b){i(a.restrictRuleOperList[0].protectTrialItemList,b,a)});for(var j=g.length,k=0;j>k;k++)for(var l=k+1;j>l;l++)$.trim(g[k].t)===$.trim(g[l].t)&&(g[k]=a.extend(g[k],g[l]),g.splice(l,1),j--);return{list:g,count:e}}}};return l});