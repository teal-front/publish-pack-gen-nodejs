/**
 ** 
 ** www.huize.com; 
 ** Version:0.1.0;
 ** Last Updated:2016-08-09; 
 **
 **/
define(["jquery","underscore","fix-float","helper","my-calendar","base","layer","message","require"],function($,a,b,c,d,e,f,g,h){"use strict";var i="",j="--",k=[],l="",m="",n=4,o=new g,p="",q="",r={periodHesitation:{name:"犹豫期限"},labelList:{name:"卖点"},satisfaction:{name:"满意度"},impressionList:{name:"买家印象"},insureAreaList:{name:"投保地区"},salePromotionList:{name:"促销信息"},sendTypeName:{name:"保单形式"}},s={init:function(){var a=(new b({el:$("#compareFloat"),fixPanel:$("#comparePanelProduct"),fixClass:"fixed-detail-tab-wrap",callback:function(a){"add"===a?$("#compareFloat").removeClass("fn-hide"):$("#compareFloat").addClass("fn-hide")}}),location.href.split("-").slice(1,5));a=$.grep(a,function(a){return"0"!==a}),c.request.postData2({url:"/api/products/comparison",data:a},function(a){p=a.result,s.render.renderProduct()}),h(["fixed-tool-float"],function(a){s.toolFloat=new a})},render:{renderControl:function(b,c){var d,e,f="",g=b.display?"":"fn-hide",h=c.unitText?c.unitText:b.showUnit?b.showUnit:"",i=b.enabled?"":"disabled";switch(b.controlType){case 0:case 2:f="<div class='hz-dropdown "+i+"' planId='"+c.planId+"' isProtect='"+c.isProtect+"' key='"+(b.key||"")+"' defaultValue='"+b.defaultValue+"' optValue='"+b.defaultValue+"' lastValue='"+b.defaultValue+"' protectItemId='"+(b.protectItemId||"")+"'><div class='input-select "+g+"'><span class='input-select-text'>"+(i?b.dictionaryList&&b.dictionaryList[0].value||b.defaultValue:b.defaultValue)+"</span><b class='iconfont'>&#xe70b;</b></div>",f+='<div class="hz-dropdown-content" style="display:none;"><ul class="hz-dropdown-menu">',$(b.dictionaryList).each(function(a,e){if(0!==e.step&&2===e.type)for(var g=e.min;g<=e.max;g+=e.step)d=g+s.utils.getUnit(e.unit),f=f+"<li planId='"+c.planId+"' key='"+(b.key||"")+"' protectItemId='"+(b.protectItemId||"")+"' class='hz-select-option' selectValue="+d+">"+d+"</li>";else d=e.value+s.utils.getUnit(e.unit),f=f+"<li planId='"+c.planId+"' key='"+(b.key||"")+"' protectItemId='"+(b.protectItemId||"")+"' class='hz-select-option' selectValue='"+d+"'>"+d+"</li>"}),f+="</div>";break;case 1:case 3:e={planId:c.planId,className:(1===b.controlType?"Wdate":"input-text ")+g,dict:JSON.stringify(b.dictionaryList&&b.dictionaryList[0]),isProtect:c.isProtect,key:b.key||"",optValue:b.defaultValue,defaultValue:b.defaultValue,enabled:i,protectItemId:b.protectItemId||""},f=a.template(m)({datas:e});break;case 4:f="";var j=b.subRestrictGeneList||[];$.each(j,function(d,e){$.each(e.dictionaryList,function(a,b){e.defaultValue===b.value&&(e.defaultText=b.byname)}),e.planId=c.planId,e.isProtect=c.isProtect,e.protectItemId=b.protectItemId||"",e.controlType="areaType",f+=a.template(l)({datas:e})}),b.dictionaryList&&b.dictionaryList.length>0&&($.each(b.dictionaryList,function(a,c){b.defaultValue===c.value&&(b.defaultText=c.byname)}),b.planId=c.planId,b.isProtect=c.isProtect,b.protectItemId=b.protectItemId||"",b.controlType="areaType",f+=a.template(l)({datas:b}));break;case 5:e={planId:c.planId,className:g,dict:JSON.stringify(b.dictionaryList&&b.dictionaryList[0]),isProtect:c.isProtect,key:b.key||"",optValue:b.defaultValue,protectItemId:b.protectItemId||""},$.each(b.dictionaryList,function(a,c){c.value===b.defaultValue&&(e.defaultValue=c.value,e.defaultText=c.value)}),e.dictionaryList=b.dictionaryList,f=a.template(l)({datas:e});break;case 6:e={planId:c.planId,className:g,dict:JSON.stringify(b.dictionaryList&&b.dictionaryList[0]),isProtect:c.isProtect,key:b.key||"",optValue:b.defaultValue,protectItemId:b.protectItemId||""},f=a.template(q)({datas:e})}return f+h+(b.notice?"</div><div class='mt10'>"+b.notice+"</div>":"")},renderProduct:function(){require(["require-text!/html/compare/compare-header.html"],function(b){var c=b.split("<area>");$("#comparePanelProduct colgroup,#compareFloat colgroup").html(a.template(c[0])({datas:p})),$("#comparePanelProduct thead,#compareFloat thead").html(a.template(c[1])({datas:p})),i=c[2],l=c[3],m=c[4],q=c[5],s.render.renderGen(),s.render.renderprotect(),s.actions.initAction(),s.actions.initInputAction(),o.hide(),$(".hz-loading-wrap").hide()})},renderGen:function(){var a=[];$.each(p,function(b,c){a=a.concat(c.restrictRuleOperList[0].restrictGenes||[])});var b=s.utils.maxProperty(a),c="<tr>",d={},e="",f=!1;for(var g in b){c=c+'<th class="tar">'+b[g].name+"</th>";for(var h=0;n>h;h++){var i=p[h];i?(d[i.planId]={},f=!1,$.each(i.restrictRuleOperList[0].restrictGenes,function(a,b){if(b.key===g||b.name===g){e=s.render.renderControl(b,{planId:i.operPlanId,isProtect:!1});((b.dictionaryList||[])[0]||{}).max,((b.dictionaryList||[])[0]||{}).step,((b.dictionaryList||[])[0]||{}).unit;d[i.planId][b.name]?c=c+","+e:(d[i.planId][b.name]=1,c=c+"<td>"+e),f=!0}}),c+="</td>",f||(c=c+"<td  planId='"+i.operPlanId+"'>-</td>")):c+="<td></td>"}c+="</tr>"}c+="</tr>",$("#genbodys").html(c)},getUnit:function(a){return{0:"",1:"份",2:"万元",3:"元",4:"0元",5:"00元",6:"000元",7:"岁",8:"年",9:"月",10:"天",11:"元/年",12:"个",13:"周岁",14:"岁"}[a]||""},renderprotect:function(){var b={},c=[];$.each(p,function(a,d){var e="",f="",g="",h=d.restrictRuleOperList[0].protectTrialItemGroup;for(var i in h)b[i]||(b[i]={}),$.each(h[i],function(a,h){if(c=d.restrictRuleOperList[0].protectTrialItemList&&d.restrictRuleOperList[0].protectTrialItemList[h]||{},c.display&&c)if(g=c.fullPremium||c.premium,e=c.showUnit?c.showUnit:"",c.name=$.trim(c.name.replace(/"/g,"")),b[i][c.name]){if(b[i][c.name][d.operPlanId]||(b[i][c.name][d.operPlanId]={}),f=b[i][c.name][d.operPlanId].text?b[i][c.name][d.operPlanId].text+"<protectItem/>":"",!g&&c.relateCoverageId){var j=s.utils.getRelateCoverageItem(c.relateCoverageId);j.display=!0,g=s.render.renderControl(j,{planId:d.operPlanId,isProtect:!1,unitText:c.showUnit}),e=""}var k=b[i][c.name][d.operPlanId].combine||"";b[i][c.name][d.operPlanId].item=c,b[i][c.name][d.operPlanId].combine=(k?k+",":"")+c.protectItemId,b[i][c.name][d.operPlanId].text=f+(g?g+e:"")}else{if(b[i][c.name]={name:c.name},b[i][c.name][d.operPlanId]={},!g&&c.relateCoverageId){var j=s.utils.getRelateCoverageItem(c.relateCoverageId);j.display=!0,g=s.render.renderControl(j,{planId:d.operPlanId,isProtect:!1,unitText:c.showUnit}),e=""}b[i][c.name][d.operPlanId].text=g?g+e:"",b[i][c.name][d.operPlanId].item=c,b[i][c.name][d.operPlanId].combine=c.protectItemId}})});var d="其他信息",e="";b[d]={},$.each(p,function(a,c){for(var f in c){if("insureAreaList"===f){$.each(c[f],function(a,b){e+=b.provinceName,b.cityName&&(e+="-"+b.cityName),b.areaName&&(e+="-"+b.areaName),e+="，"}),e=e.replace(/，$/,"");var g='<div class="inline-block insure-area" planId="'+c.operPlanId+'">'+e+"</div>";e=e.length>15?g+'<a href="javascript:;" showMore="'+c.operPlanId+'" class="inline-block primary-link">查看全部</a>':g}else"impressionList"===f?$.each(c[f],function(a,b){e+=b.title+","}):"salePromotionList"===f?$.each(c[f],function(a,b){e+=b.activityName+","}):"labelList"===f&&$.each(c[f],function(a,b){e+="<p>"+b+"</p>"});e&&(e=e.replace(/,$/,"")),"periodHesitation"===f&&c[f]&&(c[f]=c[f]+"天"),c[f]instanceof Array&&!c[f].length||r[f]&&(b[d][f]?(b[d][f][c.operPlanId]||(b[d][f][c.operPlanId]={}),b[d][f][c.operPlanId].text=e||c[f]):(b[d][f]=r[f],b[d][f][c.operPlanId]={},b[d][f][c.operPlanId].text=e||c[f])),e=""}});var f=0,g="",c={},h={};for(var j in b){g="";var k=a.template(i)({datas:{index:f,list:p,title:j}});$("#planscontent").append(k);for(var l in b[j]){g=g+"<tr><td class='tar'>"+b[j][l].name+"</td>";for(var m=0;n>m;m++){var o=p[m];if(o)if(c=b[j][l][o.operPlanId],c&&c.text){var q=c.item,t="",u=s.utils.getUnit(c.unit)||"";if(c.combine&&c.combine.toString().indexOf(",")>-1){var v=c.text.split("<protectItem/>");t="<td>";var w=c.combine.split(",");$(v).each(function(a,b){t+="<div class='mr10' planId='"+o.operPlanId+"' protectitemid='"+w[a]+"'>"+b+"</div>"}),t+="</td>",g+=t}else g=g+"<td><div  planId='"+o.operPlanId+"' protectitemid='"+(q?q.protectItemId:"")+"' class='mr10'>"+c.text+(q&&q.unit?u:"")+"</div></td>"}else c&&c.item&&c.item.relateCoverageId?(h=s.utils.getRelateCoverageItem(c.item.relateCoverageId),h.display=!0,g=g+"<td  planId='"+o.operPlanId+"' itemtype='protect'>"+s.render.renderControl(h,{planId:o.operPlanId,isProtect:!1,unitText:c.item.showUnit})+"</td>"):g+="<td>-</td>";else g+="<td></td>"}g+="</tr>"}$("#protectType"+f).html(g),f++}},showErrMsg:function(a,b){$(a).next(".write-info-error").remove(),$(a).after('<div class="hz-alert hz-alert-error  mt10 write-info-error">'+b+"</div>")},hideErrMsg:function(){$(".hz-alert").remove()}},utils:{getUnit:function(a){return{0:"",1:"份",2:"万元",3:"元",4:"0元",5:"00元",6:"000元",7:"岁",8:"年",9:"月",10:"天",11:"元/年",12:"个",13:"周岁",14:"岁"}[a]},maxProperty:function(a){var b,c={};return $.each(a,function(a,d){b=d.name,d.display&&(c[b]||(c[b]={name:d.name}))}),c},getRelateCoverageItem:function(a){var b={};return $.each(p,function(c,d){$.each(d.restrictRuleOperList[0].restrictGenes,function(c,d){d.protectItemId===~~a&&(b=d)})}),b},getPlanInfoById:function(a){var b={};return $.each(p,function(c,d){d.operPlanId===~~a&&(b.planId=d.operPlanId,b.productId=d.operProductId,b.baseProductId=d.productId,b.basePlanId=d.planId,b.platform=1,b.channel=1)}),b}},actions:{postData:function(a,b){var c=$(a).attr("planId"),d=s.utils.getPlanInfoById(c),e=[],f={},g=$("*[planId='"+c+"'][isProtect=false]"),h={protectItemId:$(a).attr("protectItemId"),key:$(a).attr("key"),value:$(a).attr("selectValue")||$(a).html()||$(a).val()};return $.each(g,function(a,b){var c=$(b),g=c.attr("key"),i=c.attr("protectItemId"),j=function(a){if(a){if(f[a])return!0;f[a]=!0}};j(g)||j(i)||(g===h.key&&i===h.protectItemId&&(c.attr("lastValue",c.attr("optValue")),c.attr("optValue",h.value),d.optGeneOldValue={protectItemId:h.protectItemId,key:h.key,value:c.attr("lastValue")}),e.push({protectItemId:i,key:g,value:c.attr("selectValue")||c.attr("optValue")||c.val()||c.html()}))}),d.genes=e,b?void b(d):void s.actions.postChange(d,function(b){if(b&&b.noticeMsg&&a[0]&&"INPUT"===a[0].tagName&&a.val(""),b.notice){var d=$("#genbodys *[planId='"+c+"'][protectItemId='"+b.notice+"'],#genbodys *[planId='"+c+"'][key='"+b.notice+"']");d.attr("lastValue",d.attr("defaultvalue")),d.val(""),d.html(""),d.attr("selectValue",""),setTimeout(function(){s.actions.postData(d)},2e3)}})},postChange:function(a,b){o.show("正在计算中..."),c.request.postData2({url:"/api/products/"+a.productId+"/restrict-rule",data:a},function(c){var d=c.result.restrictGenes||[],e=c.result.protectTrialItemList||[],g=c.result.trialPrice;o.hide(),c.result.noticeMsg&&(f.msg(c.result.noticeMsg),b(c.result)),$.each(p,function(b,d){d.operPlanId===a.planId&&(d.restrictRuleOperList[0].trialPrice=g,d.optGeneOldValue=a.optGeneOldValue,d.restrictRuleOperList[0].preminum=c.result.preminum)}),$.each(d,function(b,c){if("area"===c.key)$("*[planId='"+a.planId+"'][control='areaType']").parent().html(s.render.renderControl(c,{planId:a.planId,isProtect:!1}));else{var d;d=c.key?$("*[planId='"+a.planId+"'][key='"+c.key+"'][isProtect=false]").parent():$("*[planId='"+a.planId+"'][protectitemid='"+c.protectItemId+"'][isProtect=false]").parent(),c.display?d.html(s.render.renderControl(c,{planId:a.planId,isProtect:!1})):d.html("-")}}),$.each(e,function(b,c){var e;e=$("*[planId='"+a.planId+"'][protectitemid='"+c.protectItemId+"']"),c.display?(c.relateCoverageId&&$.each(d,function(a){this.protectItemId===~~c.relateCoverageId&&(c=this,c.display=!0)}),e.html(s.render.renderControl(c,{planId:a.planId,isProtect:!1})),"undefined"==typeof c.controlType&&e.html(c.fullPremium+c.showUnit)):e.html("-")}),s.actions.initInputAction(),s.actions.initWDate(),$(".planHeader[planId='"+a.planId+"']").html("¥"+(g.isInsure?(g.vipPrice/100).toFixed(2):j))})},initAction:function(){$("#planscontent").on("click",".hz-dropdown-content li",function(){var a=this,b=$(a).parent();s.actions.postData(a),b.parent().hide(),$(".showdropdown span").html($(a).html()),$(".showdropdown").removeClass("showdropdown")}).on("click",".input-select",function(a){var b=$(this).parent(),c=b.attr("planId"),d=b.attr("protectitemid");b.hasClass("disabled")||($(".hz-dropdown-content").hide(),$(".showdropdown").removeClass("showdropdown"),$(this).next().show(),$(this).addClass("showdropdown"),d&&$("*[planid='"+c+"'][protectitemid='"+d+"']").addClass("showdropdown"),a.stopPropagation())}).on("mouseover",".input-select",function(){$(this).addClass("input-select-highlight")}).on("mouseout",".input-select",function(){$(this).removeClass("input-select-highlight")}),$("a[showmore]").bind("click",function(){var a=$(this).attr("showmore");$(".insure-area[planId='"+a+"']").toggleClass("insure-area-open"),"查看全部"===$(this).html()?$(this).html("点击收起"):$(this).html("查看全部")}),this.initWDate(),$("body").bind("click",function(){$(".hz-dropdown-content").hide()}),$("a[addToShop]").bind("click",function(){var a=($(this).attr("planId"),[]),b={};s.actions.postData(this,function(c){b.restrictRule={platform:"1",channel:1},b.genes=c.genes,b.productId=c.productId,b.planId=c.planId,b.totalNum=1,b.inShoppingCart=!0,a.push(b),s.actions.addToShopCar(a)})}),$(".toggle-head a .iconfont").click(function(){$(this).closest("thead").siblings("tbody").toggle(),$(this).parent().toggleClass("hide-detail"),$(this).parent().hasClass("hide-detail")?$(this).html("&#xe711;"):$(this).html("&#xe712;")})},addToShopCar:function(a){c.request.postData2({url:"/api/insurance-slips",data:a},function(a){var b=a.result;return b?void c.state.checkLogin(function(a){if(a.result)f.msg("加入购物车成功"),$("#carItemCount").text(+($("#carItemCount").text()||0)+1),$(".hz-header-cart-num").text(+($(".hz-header-cart-num").text()||0)+1);else{var d=c.cookie.getCookie("InsureNums");if(d.split(",").length>20)return void f.msg("最多只能添加20个产品");$(b).each(function(a,b){-1===d.indexOf(b.insureNum)&&(d?d=d+","+b.insureNum:d+=b.insureNum,c.cookie.setCookie("InsureNums",d,864e5,".huize.com"))}),f.msg("加入购物车成功"),$("#carItemCount").text(+($("#carItemCount").text()||0)+1),$(".hz-header-cart-num").text(+($(".hz-header-cart-num").text()||0)+1)}}):void f.msg(a.message||"添加购物车失败")})},initWDate:function(){$("#planscontent input.Wdate").each(function(a,b){var c=JSON.parse($(b).attr("dict")),d=0,e=0,f=0,g=0;if("岁"===s.utils.getUnit(c.unit)||"周岁"===s.utils.getUnit(c.unit)?(d=c.min,e=c.max):"天"===s.utils.getUnit(unit)&&(f=c.min,g=c.max),c.subrestrict&&"天"===s.utils.getUnit(c.subrestrict.unit)){var h=c.subrestrict.max,i=c.subrestrict.min;h&&(f=h),i&&(g=i)}var j=s.createDate({newDate:s.getCurrentTime(new Date),year:-d,date:f}),l=s.createDate({newDate:s.getCurrentTime(new Date),year:-e-1,date:g});k[a]=new MyCalendar({el:b,maxDate:j,minDate:l,callback:function(a,c){"date"===c.type&&s.actions.postData(b)}})})},initInputAction:function(){$("#planscontent .input-text").die().live("blur",function(){var a=$(this),b=a.val(),c=a.attr("planId"),d=a.attr("protectitemid"),e=JSON.parse(a.attr("dict"));return b%e.step!==0?void s.render.showErrMsg(this,"请输入"+e.step+"的倍数"):b<e.min||b>e.max?void s.render.showErrMsg(this,"请输入范围"+e.min+"到"+e.max):(a.attr("protectitemid")&&$("*[planid='"+c+"'][protectitemid='"+d+"']").val(b),s.render.hideErrMsg(),s.actions.postData(a),void s.render.hideErrMsg())})}}};return e.extend(s,new e),s});