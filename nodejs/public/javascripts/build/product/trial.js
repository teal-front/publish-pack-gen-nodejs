/**
 ** 
 ** www.huize.com; 
 ** Version:0.1.0;
 ** Last Updated:2016-08-09; 
 **
 **/
define(["jquery","base","trial-render","my-calendar","message","layer","jquery-prompt"],function($,a,b,c,d,e){"use strict";var f=function(a){var b=a||{};for(var c in b)this[c]=b[c];this.message=new d,this.init()};f.prototype={ready:function(){},change:function(){},render:function(){this.genesArea.html(this.renderGenes()),this.protectArea.html(this.renderProtect())},init:function(){"true"===this.getQueryValue("dev")&&(this.info("调试模式开启：前端渲染页面"),this.setData(),this.render()),this.setDefaultValue(),this.eventInit(),this.ready(),this.change(),this.mergeIdenticalProtectItem()},productId:"",productPlanId:"",baseProductId:"",baseProductPlanId:"",platform:1,channel:1,loadProtectDesc:!0,messageTimeOut:2e3,eventInit:function(){},getGenes:function(){var a=this,b=[];return a.genesArea.find(".trial-list").each(function(c,d){var e,f=$(this).find("."+a.itemStyle),g=$(this).find("."+a.activeStyle+",input.trial-item,.product-amount-input,.hz-dropdown[disabled]"),h=g.data("protectitemid"),i=g.data("key"),j=void 0!==g.data("default-value")?g.data("default-value"):g.val()||"",k=$(d).find(".hz-dropdown[address]");if(k.length)k.each(function(a,c){e={protectItemId:"",key:$(c).attr("address"),value:String($(c).data("default-value"))},b.push(e)});else{if(!(h||i||(h=f.data("protectitemid"),i=f.data("key"),h||i)))return;e={protectItemId:String(h),key:i,value:String(j)},b.push(e)}}),b},getProductInfo:function(a){var b=a||{};return this.extend({planId:this.productPlanId,productId:this.productId,baseProductId:this.baseProductId,basePlanId:this.baseProductPlanId,platform:this.platform,channel:this.channel},b)},getData:function(){}};var g=function(){};g.prototype={listStyle:"trial-list",itemStyle:"trial-item",activeStyle:"filter-active-tag",eventInit:function(){var a=this;a.eventEnterValue(),a.eventSelect(),a.eventPlugin(),a.eventCalendar(),$(".insurant-date-limit-select").change(function(){$(this).parents(".hz-dropdown-content").find(".error-text").hide().find("span").text("")})},calendar:[],insurantDateStart:{max:"",min:""},insurantDateEnd:{max:"",min:""},eventCalendar:function(){var a=this;a.genesArea.find(".trial-calendar").each(function(b){var d=($(this).data("maxdate")||"",$(this).data("mindate")||"",$(this).data("max")||0),e=$(this).data("min")||0,f=$(this).data("unit")||0,g=$(this).data("list")||"[]",h="",i="";if(!$(this).data("lock")){$(this).data("lock",!0);var j=new Date,k=(new Date,new Date,j.getFullYear(),j.getDate(),0),l=0,m=0,n=0,o=0,p=0,q=0;if("岁"===a.getUnit(f)||"周岁"===a.getUnit(f)?(l=e,m=d,k=1):"天"===a.getUnit(f)&&(n=e,o=d),h=d+a.getUnit(f),i=e+a.getUnit(f),g.subrestrict&&"天"===a.getUnit(g.subrestrict.unit)){var r=g.subrestrict.max,s=g.subrestrict.min;r&&(p=r),s&&(q=s)}var t=a.createDate({newDate:a.getCurrentTime(new Date),year:-l,date:-n+p}),u=a.createDate({newDate:a.getCurrentTime(new Date),year:-m-k,date:-o+q});a.calendar[b]=new c({el:this,maxDate:t,minDate:u,callback:function(b,c){"date"===c.type&&a.postChange()}})}}),a.travel={start:{max:"",min:""},end:{max:"",min:""}},a.genesArea.find(".trial-insurant-date-limit").each(function(){$(this).data("lock")||($(this).data("lock",!0),new c({el:this,zIndex:55555,minDate:function(){var b=$(this.el).data("type"),c="",d=$('[data-type="start"]'),e=d.val(),f=a.createDate({date:1});return"start"===b?c=f:"end"===b&&(c=e?e:f),c},maxDate:function(){var a=$(this.el).data("type"),b="",c=$('[data-type="end"]'),d=c.val();return"start"===a&&(b=d?d:""),b},callback:function(b,c){var d=$(this.el),e=d.parents(".hz-dropdown-content"),f=e.find('[data-type="start"]').val(),g=e.find('[data-type="end"]').val(),h=e.find("[data-tips]"),i=e.find("[data-date]"),j=e.find("select"),k=a.dateDifference(f,g),l=!1,m=365,n=0;"date"===c.type&&f&&g&&(k>=0?(h.hide().find("span").html(""),0===k?k=1:k++,l=k%m===0,n=k/m,i.html("<strong>"+k+"天</strong>"),a.__findSelectValue(j,k+"天")?(j.val(k+"天"),a.__selectTimeStatus=!0):a.__findSelectValue(j,n+"年")&&l?(j.val(n+"年"),a.__selectTimeStatus=!0):(h.show().find("span").html(a.TEXT_DATE_INVALID),a.__selectTimeStatus=!1)):(i.html(""),h.show().find("span").html(a.TEXT_DATE_ERROR),a.__selectTimeStatus=!1))}}))}),a.genesArea.find(".hz-check-item").off("click").on("click",function(){var a=$(this).nextAll(".calendar-box-wrap");$(this).toggleClass("hz-check-item-checked"),c.closeAll(),$(this).hasClass("hz-check-item-checked")?a.removeClass("fn-hide"):a.addClass("fn-hide")})},__selectTimeStatus:!1,__findSelectValue:function(a,b){var c=!1;return a.find("option").each(function(){var a=$(this).attr("value");a===b&&(c=!0)}),c},eventEnterValue:function(){var a=this;a.el.find(".only-number").blur(function(){a.validateInput(this)||$(this).val("")}),a.el.find(".only-number").enterOnlyNumber(),a.el.find(".product-amount-wrap").eidtNumber({})},setOldValue:function(a,b){var c=this,d=a.data("protectitemid"),e=a.data("key"),f=b||a.data("default-value");c.optGeneOldValue={},d&&(c.optGeneOldValue.protectItemId=d),e&&(c.optGeneOldValue.key=e),c.optGeneOldValue.value=c.replaceNull(f)},validateInput:function(a){var b=$(a),c=b.val(),d=b.data("max"),e=b.data("min"),f=b.data("step"),g=!1;return $.isNumeric(c)?(d&&(c>d?(b.val(""),g=!1):g=!0),e&&(e>c?(b.val(""),g=!1):g=!0),g=(c-e)%f===0):b.val(""),g},getOldValue:function(a){var b=this,c=$(a),d=$(a).parents(".trial-list"),e=d.find("."+b.activeStyle).length?d.find("."+b.activeStyle):d.find("span."+b.itemStyle),f=e.data("protectitemid"),g=e.data("key");b.optGeneOldValue={},f||g||(f=c.data("protectItemid")||"",g=c.data("key")||""),f&&(b.optGeneOldValue.protectItemId=f),g&&(b.optGeneOldValue.key=g),b.optGeneOldValue.value=e.data("default-value")||e.text()||c.val(),b.info(b.optGeneOldValue)},setSelectValue:function(a,b){var c=this,d=!1;if(b)return a.find(".hz-dropdown-menu >li").each(function(){var c=$(this).data("default-value"),e=a.find("input");b===c&&(a.find("li").removeClass("hz-select-option-selected"),e.val(b),$(this).addClass("hz-select-option-selected"),d=!0)}),d&&(a.parent().find("."+c.itemStyle).removeClass(c.activeStyle),a.data("default-value",b).addClass(c.activeStyle)),d},setDefaultValue:function(){},eventSelect:function(){var a=this;a.genesArea.on("click","[address]",function(b){($(b.target).hasClass("input-select-text")||$(b.target).hasClass("iconfont"))&&(a.optGeneOldValue={},a.optGeneOldValue.protectItemId="",a.optGeneOldValue.key=String($(this).attr("address")),a.optGeneOldValue.value=String($(this).data("default-value")))}).on("change","."+a.itemStyle,function(){var b=$(this).val();$(this).parent().find("."+a.activeStyle).removeClass(a.activeStyle),$(this).parent().find('[data-default-value="'+b+'"]').addClass(a.activeStyle),$(this).hasClass("trial-calendar")||a.postChange()}).on("focus","."+a.itemStyle,function(b){$(this).is("input")&&a.getOldValue(b.target)}).on("click","."+a.itemStyle,function(b){var c,d,e=$(this).parents("."+a.listStyle),f=e.find("."+a.activeStyle),g=f.data("protectitemid")||"",h=f.data("key")||"",i=f.data("default-value")||"",j=$(this).data("unit")||"",k="",l=$(this).attr("controltype");if(!$(this).hasClass("disabled")&&!$(this).is("li")&&!$(this).hasClass("filter-tag-text")){if($(this).is("input"))return void("click"===b.type&&a.getOldValue(b.target));a.optGeneOldValue={},g&&(a.optGeneOldValue.protectItemId=g),h&&(a.optGeneOldValue.key=h),g||h||(g=$(this).data("protectitemid"),h=$(this).data("key"),g&&(a.optGeneOldValue.protectItemId=g),h&&(a.optGeneOldValue.key=h)),a.optGeneOldValue.value=i,e.find("."+a.itemStyle+",.hz-dropdown").removeClass(a.activeStyle),e.find(".hz-dropdown .input-select-text").text(a.TEXT_SELECT_MORE),e.find(".hz-dropdown").find("li.hz-select-option").removeClass("hz-select-option-selected"),e.find(".hz-dropdown").data("default-value"),$(this).hasClass("filter-tag")&&($(this).addClass(a.activeStyle),e.find(".input-select>.trial-item,input.product-amount-input").val(e.find("."+a.activeStyle).data("default-value")),e.find("input.product-amount-input").trigger("reset"),a.postChange()),c=a.protectArea.find('.hz-dropdown[data-protectitemid="'+(g||"test")+'"],.hz-dropdown[data-key="'+(h||"test")+'"]'),d=$(this).data("default-value"),3===a.toInt(l)&&(k=j),(g||h)&&(c.data("default-value",d).addClass(a.activeStyle).find(".input-select-text").text(d+k),c.find("li").removeClass("hz-select-option-selected"),c.find('li[data-value="'+d+'"],li[data-default-value="'+d+'"]').addClass("hz-select-option-selected"))}})},eventPlugin:function(){var a=this;a.el.find(".trial-calendar").click(function(){var b=$(this).data("key"),c=$(this).data("protectitemid");a.optGeneOldValue={},b&&(a.optGeneOldValue.key=b),c&&(a.optGeneOldValue.protectItemId=c),a.optGeneOldValue.value=$(this).val()}),a.el.find(".hz-dropdown").dropDown({type:1,event:function(a){return!$(a.target).hasClass("iconfont")&&!$(a.target).hasClass("more-tag")},select:function(b){return a.dropDownCallback1(this,b)}}),a.bindPrompt()},__getItemOldValue:function(a){var b=this,c=$(a),d=c.find("."+b.activeStyle).eq(0),e=c.find("."+b.itemStyle+",.hz-dropdown").data("key"),f=c.data("protectitemid"),g=d.data("default-value")||"";b.optGeneOldValue={},e&&(b.optGeneOldValue.key=e),f&&(b.optGeneOldValue.protectItemId=f),b.optGeneOldValue.value=g,b.info(b.optGeneOldValue)},dropDownCallback1:function(a,b){var c,d,e,f=this,g=!1,h=$(b.target),i=$(a),j=i.find(".input-select-text"),k=(i.find(".hz-select-option"),i.parents("."+f.listStyle)),l=i.find(".input-enter"),m=i.find(".error-text"),n=i.find('[data-type="start"]'),o=i.find('[data-type="end"]'),p=i.find(".hz-check-item"),q=i.data("protectitemid"),r=i.data("key"),s=q||r,t=f.toInt(h.attr("controltype")),u=!!i.attr("address"),v="true"===i.attr("protect"),w=h.hasClass(f.itemStyle),x=h.data("value")||h.data("default-value"),y="time"===h.attr("edit"),z="ok"===h.attr("edit"),A="cancel"===h.attr("edit"),B=function(a){var b=a||"";i.data("default-value",b),i.find("li").removeClass("hz-select-option-selected"),h.addClass("hz-select-option-selected")},C=function(){k.find("."+f.itemStyle+",.hz-dropdown").removeClass(f.activeStyle),i.addClass(f.activeStyle)},D=function(a,b){var c=a||"",d=b||"请输入合法内容";c?m.hide().find("span").text(""):m.show().find("span").text(d)};if(w){if(j.text(h.text()),u){var E=i.data("key"),F=i.data("protectitemid"),G=i.data("default-value");f.optGeneOldValue={},E&&(f.optGeneOldValue.key=E),F&&(f.optGeneOldValue.protectItemId=F),f.optGeneOldValue.value=G,f.info(f.optGeneOldValue),f.postChange()}else{var H=f.protectArea.find('.hz-dropdown[data-protectitemid="'+s+'"],.hz-dropdown[data-key="'+s+'"]'),I=H.find('.hz-select-option[data-protectitemid="'+s+'"][data-value="'+x+'"],.hz-select-option[data-key="'+s+'"][data-value="'+x+'"]');if(v){var J=f.genesArea.find('[data-protectitemid="'+(s||"test")+'"],[data-key="'+(s||"test")+'"]'),K=J.find(".hz-dropdown");3===t&&(x=parseInt(x,10)),J.find(".trial-item,.hz-dropdown").removeClass(f.activeStyle),J.find(".hz-dropdown").attr("data-default-value","").data("default-value","");var L=J.find('[data-default-value="'+x+'"]');L.addClass(f.activeStyle),L.length||(K.addClass(f.activeStyle).find(".input-select-text").text(x),K.data("default-value",x),K.find(".hz-select-option").removeClass("hz-select-option-selected"),K.find('.hz-select-option[data-value="'+x+'"]').addClass("hz-select-option-selected")),c=i.data("key"),d=i.data("protectitemid"),e=i.data("default-value"),f.optGeneOldValue={},c&&(f.optGeneOldValue.key=c),d&&(f.optGeneOldValue.protectItemId=d),f.optGeneOldValue.value=e,f.info(f.optGeneOldValue),0===t&&(H.addClass(f.activeStyle),H.find("li").removeClass("hz-select-option-selected"),I.addClass("hz-select-option-selected"),H.find(".input-select-text").text(I.eq(0).text()),H.data("default-value",I.data("value"))),f.logRed("保障项下拉")}else H.addClass(f.activeStyle),H.find("li").removeClass("hz-select-option-selected"),I.addClass("hz-select-option-selected"),H.find(".input-select-text").text(I.eq(0).text()),H.data("default-value",I.data("value")),f.__getItemOldValue(k),3===t&&(x=parseInt(x,10)),h.parents(".hz-dropdown").attr("data-default-value",x),f.logGreen("试算因子下拉");f.postChange(),C()}g=!0,B(x)}else if(y){var M=i.find("select").val();if(g=!1,D(M),p.hasClass("hz-check-item-checked")&&(!n.val()||!o.val()))return void D("",f.TEXT_DATE_INVALID);if(M===f.TEXT_SELECT_MORE)return g=!1,void D();f.__getItemOldValue(k),C(),j.text(M),i.data("default-value",M),g=!0,f.postChange()}else if(z){var M=l.val(),N="",O=i.find('.hz-select-option[data-value="'+M+'"]'),P=h.data("unit");if(g=!1,f.__getItemOldValue(k),D(M),!M)return g=!1,!1;if(O.length)O.click();else{if(3!==t&&(N=M),C(),j.text(M+(i.data("unit")||f.getUnit(l.data("unit"))||"")),i.data("default-value",M),v){c=i.data("key"),d=i.data("protectitemid"),e=i.data("default-value"),c&&(f.optGeneOldValue.key=c),d&&(f.optGeneOldValue.protectItemId=d),f.optGeneOldValue.value=e,f.info(f.optGeneOldValue);var J=$('dd[data-protectitemid="'+s+'"]'),Q=J.find('[data-protectitemid="'+s+'"][data-default-value="'+M+'"]');J.find("."+f.itemStyle+",.hz-dropdown").removeClass(f.activeStyle),Q.length?Q.addClass(f.activeStyle):J.find(".hz-dropdown").data("defaultValue",M).addClass(f.activeStyle).find(".input-select-text").text(M),i.find(".hz-select-option").removeClass("hz-select-option-selected"),i.find('.hz-select-option[data-default-value="'+N+'"]').addClass("hz-select-option-selected"),j.text(N+f.getUnit(l.data("unit")))}else{var R=f.protectArea.find('.hz-dropdown[protect="true"][data-protectitemid="'+s+'"]');R.data("default-value",M),R.find(".input-select-text").text(M),R.addClass(f.activeStyle),R.find(".hz-select-option").removeClass("hz-select-option-selected"),R.find('.hz-select-option[data-default-value="'+N+'"],.hz-select-option[data-default-value="'+N+P+'"]').addClass("hz-select-option-selected")}f.postChange(),g=!0}}return A&&(g=!0),g},optGeneOldValue:{key:"",protectItemId:"",value:""},postDelayTime:300,__postTimer:null,postChange:function(){var a=this;a.postDelayTime?(clearTimeout(a.__postTimer),a.__postTimer=setTimeout(function(){a.postChangeData()},a.postDelayTime)):a.postChangeData()},bindPrompt:function(){$(".trial-prompt").prompt({position:"top"})},getGenesString:function(){var a=this,b=a.getProductInfo({genes:a.getGenes()||[],optGeneOldValue:a.optGeneOldValue});return b=window.JSON2?JSON2.stringify(b):JSON.stringify(b),a.info(b),a.trialString=b,b},trialString:"",postChangeData:function(){var a=this;a.logRed((a.optGeneOldValue.key||a.optGeneOldValue.protectItemId)+" 的旧值："+a.optGeneOldValue.value),a.message.show(a.TEXT_UPDATING,"loading"),$.post("/api/products/"+a.productId+"/restrict-rule",{data:a.getGenesString(),time:a.getTime()},function(b){if(a.message.hide(),a.updateRender(b.result),b&&b.result&&b.result){if(b.result.notice){var c=$('[data-protectitemid="'+b.result.notice+'"],[data-key="'+b.result.notice+'"]'),d=c.find("."+a.activeStyle),f=d.data("default-value");d.removeClass(a.activeStyle),f&&(a.optGeneOldValue={},"string"==typeof f?a.optGeneOldValue.key=b.result.notice:a.optGeneOldValue.protectItemId=b.result.notice,a.optGeneOldValue.value=f),setTimeout(function(){a.postChangeData()},a.messageTimeOut)}return void(b.result.noticeMsg&&(b.result.restrictResult&&b.result.restrictResult.status&&"36058"===b.result.restrictResult.status?e.msg("保监会规定单笔保费不能超过20万哦~您可以降低保额或者分几单提交投保！"):e.msg(b.result.noticeMsg)))}"00000"!==b.status&&a.message.show(b.message,"warning",a.messageTimeOut)})},updateProtect:function(a){var b=this,c=a||{},d=c.protectTrialItemList||[],e=c.restrictGenes||[];d.forEach(function(a,c){var d=a.description||"",f=$('[id="protect-'+a.protectItemId+"-"+a.trialItemId+'"]'),g="",h=[];e.forEach(function(c){b.toInt(a.relateCoverageId)!==b.toInt(c.protectItemId)&&b.toInt(a.relateCoverageId)!==b.toInt(c.key)||(g=c)}),h.push('<li class="ensure-protect-item '+b.listStyle+'" id="protect-'+a.protectItemId+"-"+a.trialItemId+'" protectname="'+a.name+'" trialItemId="'+a.trialItemId+'">'),h.push('<div class="row01"><div class="protect-item-icon">'+(a.icon?'<img src="'+a.icon+'" width="24" height="24" alt="图标" title="'+a.name+'"/>':'<i class="iconfont icon-item f24">&#xe702;</i>')+"</div></div>"),h.push('<div class="row02"><div class="protect-item-name">'+a.name+"</div></div>"),h.push('<div class="row03">'),a.relateCoverageId?(3!==g.controlType||g.dictionaryList||b.genesArea.find('[data-protectitemid="'+g.protectItemId+'"]').removeClass("filter-active-tag"),h.push(b.renderForm({item:a,formObject:g,isProtect:!0}))):h.push((a.fullPremium?a.fullPremium:a.premium)||""),h.push(a.showUnit),h.push("</div>"),h.push('<div class="row04"><div class="protect-item-des f12 fc6">'+d+"</div></div>"),h.push("</li>"),f.after(h.join("")),f.remove()})},updateRender:function(a){var b=this,c=a.restrictGenes||[];b.preminum=a.preminum||b.notInsureText,b.trialPrice=a.trialPrice||{},b.change(),b.setPrice(),b.info(a),b.updateProtect(a),$(".golden-span").text(b.trialPrice.goldenBean),c.forEach(function(a){var c,d=a.protectItemId||a.key,e=a.display===!1?"hidden":"",f=b.renderForm({formObject:a,disabled:a.disabled}),g=b.renderGenesRow({boxClass:e,name:a.name,item:a,id:a.protectItemId||a.key,content:f});c=$("#list-item-"+b.productPlanId+"-"+d),a.enabled===!1&&"area"===a.key?c.find(".trial-item,.hz-dropdown").addClass("disabled"):(c.after(g),c.remove()),b.setDefaultValue(),b.eventEnterValue(),b.eventPlugin(),b.eventCalendar(),b.mergeIdenticalProtectItem()})},mergeIdenticalProtectItem:function(){var a=this;a.protectArea.find("[protectname]").each(function(){var b=$(this).attr("protectname");a.protectArea.find('[protectname="'+b+'"]').each(function(a){var b="";b=a?"hidden":"",$(this).find(".row01,.row02").css({visibility:b})})})}};var h=function(){};return h.prototype={TEXT_DATE_INVALID:"您选择的日期无效，请重新选择！",TEXT_DATE_ERROR:"出发日期不能晚于结束日期",TEXT_UPDATING:"正在更新..."},a.extend(f.prototype,new a),a.extend(f.prototype,new b),a.extend(f.prototype,new g),a.extend(f.prototype,new h),f});