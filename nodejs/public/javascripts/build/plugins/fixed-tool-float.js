/**
 ** 
 ** www.huize.com; 
 ** Version:0.1.0;
 ** Last Updated:2016-08-09; 
 **
 **/
define(["jquery","underscore","exports","require","module","helper","layer"],function($,a,b,c,d,f,g){"use strict";var h,i,j=!1,k="checkCompareIds",l="compareProducts",m="//www.huize.com/contrast-0-0-0-0",n=function(){n.prototype.init.apply(this,arguments)};n.prototype={init:function(a){var b=this;this.config=a,c(["require-text!/html/product/fixed-tool-float.html"],function(a){$("body").append(a),i=$("#fixedsidetool"),b.initAction();var c=f.cookie.getCookie(l),d=$.grep(c.split(","),function(a){return""!==a});$("#compareCount").html(d.length+"/4"),b.refreshShopCar(),b.refreshToolPosition(!0)})},initAction:function(){var a=$("#toolPanel",i),b=$("#panelTitle",i),c=this;i.on("click","#showCarBtn",function(){a.show(),$(".comparer-item",i).addClass("fn-hide"),$(".car-item:not(.items-empty)",i).removeClass("fn-hide"),$("#feedCallback").addClass("fn-hide"),j&&$("#loginBtn").addClass("fn-hide"),c.refreshShopCar(!0),b.html("购物车")}).on("click","#loginBtn",function(){requirejs(["sign-float"],function(a){new a({returnUrl:location.href,showRegister:!1,callback:function(a){location.reload()}})})}).on("click","#deleteAll",function(){f.cookie.setCookie(l,"",null,".huize.com"),c.loadComparePro(),$("#compareTips,#comparerItemTip,#deleteAll",i).addClass("fn-hide"),f.cookie.setCookie(k,"",null,".huize.com"),c.setStartComparaStats(0),$("#addToCompare").removeClass("hz-check-item-checked"),$("#addToCompare .hz-check-text").text("加入对比")}).on("click","#comparePanel .hz-check-item",function(){$(this).toggleClass("hz-check-item-checked");var a,b=$(this).attr("planId"),d=f.cookie.getCookie(k);a=$(this).hasClass("hz-check-item-checked")?c.cookieStr(d,b,1):c.cookieStr(d,b,2),f.cookie.setCookie(k,a,null,".huize.com");var e=$("#comparePanel .hz-check-item-checked");c.setStartComparaStats(e.length)}).on("click","#toPay",function(){f.page.openNewTag("//is.huize.com/shopping-cart/")}).on("click","#showProductBtn",function(){a.show(),$(".comparer-item:not(.items-empty)",i)&&($(".comparer-item:not(.items-empty)",i).removeClass("fn-hide"),$("#compareTips,#comparerItemTip,#deleteAll").addClass("fn-hide")),$(".car-item",i).addClass("fn-hide"),$("#feedCallback").addClass("fn-hide"),b.html("产品对比"),c.loadComparePro()}).on("click","#startCompara",function(){var a=$("#comparePanel .hz-check-item-checked");if(a.length<2)return void g.msg("对比的产品不能小于两个");var b=m;a.each(function(a,c){4>a&&(b=b.replace("-0","-"+$(c).attr("planId")))}),f.page.openNewTag(b)}).on("click","#comparePanel .hz-close",function(){var a=$(this).attr("planId");c.delcomparePro(a);var b=$("#comparePanel .hz-check-item-checked");c.setStartComparaStats(b.length)}).on("click",".side-tool-back",function(){a.hide()}).on("click","#feedBtn",function(){a.show(),$(".comparer-item",i).addClass("fn-hide"),$(".car-item",i).addClass("fn-hide"),$("#feedCallback").removeClass("fn-hide"),$("#panelTitle").html("意见反馈"),$("#feedback-area").placeholder({blankCharacter:!1,wrapTagName:!1})}).on("click","#feedCall",function(){var b=this,c=$.trim($(".side-tool-feedback-area").val()),d=$("#feedCallback .hz-alert-error");if(!c)return void d.html("内容不能为空");if(c.length>500)return void d.html("内容不能超过500个字");if(!$(this).attr("posting")){$(this).attr("posting","true"),d.html(""),$(this).html("正在提交......");var e=$("#feedCallback .hz-radio-item-checked").attr("satfix");$.trim(c)&&(f.cookie.setCookie("suggest",$.trim(c),null,".huize.com"),f.request.getCrossJson({url:"//www.huize.com/Feedback/AddFeedback",data:{createTime:f.dateHelper.formatDate("yyyy-MM-dd hh:mm:ss",new Date),addressUrl:location.href,isSatisfied:e,title:document.title}},function(c){c.IsSuccess?(d.html(""),g.msg("提交成功"),a.hide()):d.html(c.Message),$(b).attr("posting",""),$(b).html("提交")}))}}).on("mouseover",".tool-function-item",function(){$(this).addClass("side-tool-current")}).on("mouseout",".tool-function-item",function(){$(this).removeClass("side-tool-current")}).on("keydown",".side-tool-feedback-area",function(){var a=$.trim($(this).val()).length+1,b=e.keyCode;return 8===b?!0:a>500?!1:void 0}).on("click","#feedCallback .hz-radio-item",function(){$("#feedCallback .hz-radio-item").removeClass("hz-radio-item-checked"),$(this).addClass("hz-radio-item-checked")}).on("click","#kefu",function(){var a=f.cookie.getCookie("userId");window.open("http://kefu.hzins.com/chat?domain=hzins&businessType=Xm4FWr0dncw&referrer="+encodeURIComponent(window.location.href)+"&msrc=HZ&title="+encodeURIComponent(document.title)+"&mid="+encodeURIComponent(a),"kefu","toolbar=no,location=no,directories=no,resizable=yes,status=yes,menubar=no,scrollbars=yes,width=800,height=600,left=0,top=0")}),$("body").bind("click",function(b){$(b.target).parents("#fixedsidetool").length||$(b.target).parents(".layui-layer-dialog").length||a.hide()});var d=function(){var a=window.document.body.clientWidth||0;$("#detialTab").hasClass("fixed-detail-tab-wrap")&&1190>a?$("#detialTab .layout").width(a):$("#detialTab .layout").width(1190),$("#silderbar").hasClass("fixed-sidebar")&&1190>a?$("#silderbar").css("right","6px"):$("#silderbar").css("right","auto")};window.onresize=function(){c.refreshToolPosition(),$("#detialTab").length>0&&d()},setInterval(function(){var a=$.trim($(".side-tool-feedback-area",i).val());$("#charCount",i).html(a.length)},500)},refreshToolPosition:function(a){var b=window.document.body.clientWidth,c=$("#fixedsidetool"),d=$("#wrapToolMenu"),e=window.document.documentElement.clientHeight;1262>b?(a?(c.css("right","-35px"),d.css({position:"relative",left:"-35px"})):0===$("#toolPanel:visible").length&&(c.animate({right:"-35px"},30),d.css({position:"relative"}).animate({left:"-35px"},100)),c.bind("mouseleave",function(){0===$("#toolPanel:visible").length&&(c.animate({right:"-35px"},100),d.animate({left:"-35px"},100))}),d.bind("mouseover",function(){$(this).animate({left:"0"},30),c.animate({right:"0"},30)})):(a?(c.css("right",0),d.css({position:"relative",left:"0"})):(c.animate({right:"0"},300),d.css("position","relative").animate({left:"0"},300)),d.unbind("mouseover"),c.unbind("mouseleave")),540>=e?$(".side-tool-other").hide():$(".side-tool-other").show()},refreshShopCar:function(b){var c=this;f.state.checkLogin(function(d){if(j=d.result){if(f.request.getJson({url:"/api/shopping-cart/items/count"},function(a){$("#fixedsidetool #carItemCount").html(a.result),$(".hz-header-cart-num").html(a.result)}),f.request.getJson({url:"/api/users/customer-service"},function(a){h=a.result}),!b)return}else;f.request.getJson({url:"/api/shopping-cart/list"},function(b){if(b.message)return void g.msg(b.message);var d=b.result;d.length?($(".car-item.items-empty").addClass("fn-hide"),$("#carItemCount",i).html(d.length),$(".hz-header-cart-num").html(d.length)):($(".car-item.items-empty").removeClass("fn-hide"),$("#carItemCount",i).html(0),$(".hz-header-cart-num").html(0)),$("#shopcarList",i).html(a.template($("#shopcarhtml").html())({datas:d})),$("#failList",i).html(a.template($("#failItems").html())({datas:d})),$("#failList li",i).length>0&&$("#failList").parent().removeClass("fn-hide");var e=[];$("#shopcarList li",i).each(function(a,b){var c=$(this),d=c.attr("data-type")||"";"plan"===d?c.find(".plan-hidden").each(function(){e.push({insuranceNum:$(this).attr("insureNum"),premium:$(this).attr("premium")})}):e.push({insuranceNum:c.attr("insureNum"),premium:c.attr("premium")})}),0!==e.length?f.request.postData2({url:"/api/insurance-slips/amount/choosed",data:e},function(a){a.result&&$("#totalPrice").html(((a.result.totalPremium-a.result.totalDiscount)/100).toFixed(2))}):$("#totalPrice").html("0.00"),c.refreshCount(),$("#shopcarList,#failList",i).delegate(".delbtn","click",function(){var a=this;g.confirm('<p class="pt45 pb45 tac">确认要从购物车中删除该产品吗？</p>',{btn:["取消","确定"],area:"530px",title:!1},function(){g.closeAll()},function(){var d=$(a).attr("data-type")||"";if(j){var e="";"plan"===d?(e="/api/shopping-cart/items?projectInsuranceGroup="+$(a).attr("data-group")+"&type="+d,b={projectInsuranceGroup:$(a).attr("data-group")}):(e="/api/shopping-cart/items?insuranceNum="+$(a).attr("pid"),b={insureNum:$(a).attr("pid")}),f.request.postData({url:e,method:"DELETE",data:b},function(a){a.result?(g.msg("删除成功"),c.refreshShopCar(!0)):g.msg("删除失败")})}else{var h=f.cookie.getCookie("InsureNums"),i=$(a).attr("pid");"plan"===d?$(a).parents("li").find("input[type=hidden]").each(function(){var a=$(this).attr("insurenum");f.cookie.setCookie("InsureNums",c.cookieStr(h,a),0,".huize.com"),h=f.cookie.getCookie("InsureNums")}):f.cookie.setCookie("InsureNums",c.cookieStr(h,i),0,".huize.com"),g.msg("删除成功"),c.refreshShopCar(!0)}})})})})},refreshCount:function(){$("#productCount",i).html($("#shopcarList li").length),$("#failCount",i).html($("#failList li").length)},loadComparePro:function(){var b=f.cookie.getCookie(l),c=this,d=[];b&&(d=b.split(",")),d=$.grep(d,function(a){return""!==a}),d.length?($(".comparer-item.items-empty").addClass("fn-hide"),$("#compareTips,#comparerItemTip,#deleteAll").removeClass("fn-hide")):$(".comparer-item.items-empty").removeClass("fn-hide"),f.request.postData2({url:"/api/products/plans/list",data:d},function(b){$("#comparePanel").html(a.template($("#comparehtml").html())({datas:b.result})),$("#compareCount #fixedsidetool").html(b.result.length+"/4"),$("#compareCount").html(b.result.length+"/4");var d=f.cookie.getCookie(k);$("#comparePanel .hz-check-item").each(function(){d.indexOf($(this).attr("planId"))>-1&&$(this).addClass("hz-check-item-checked")}),c.setStartComparaStats($("#comparePanel .hz-check-item-checked").length)})},setStartComparaStats:function(a){a>1?($("#compareTips").addClass("fn-hide"),$("#startCompara").removeClass("disabled")):($("#compareTips").removeClass("fn-hide"),$("#startCompara").addClass("disabled"),0===a&&$("#deleteAll").addClass("fn-hide"))},getCompareCount:function(){var a=f.cookie.getCookie(l);return a.indexOf("|")>-1&&(a=""),a=a.split(","),a=$.grep(a,function(a){return""!=a}),a.length},delcomparePro:function(a){var b=f.cookie.getCookie(l);b.indexOf("|")>-1&&(b=""),b=this.cookieStr(b,a),b=b.split(","),b=$.grep(b,function(a){return""!=a}),$("#compareCount").html(b.length+"/4"),f.cookie.setCookie(l,b.join(","),null,".huize.com");var c=f.cookie.getCookie(k),d=this.cookieStr(c,a,2);f.cookie.setCookie(k,d,null,".huize.com"),this.loadComparePro()},addcomparePro:function(a){var b=f.cookie.getCookie(l),c=f.cookie.getCookie(k);return b.indexOf("|")>-1&&(b=""),b=this.cookieStr(b,a,1),b.split(",").length>4?void g.msg("对比数目最大不能超过4个"):(c=this.cookieStr(c,a,1),f.cookie.setCookie(k,c,null,".huize.com"),$("#compareCount").html(b.split(",").length+"/4"),f.cookie.setCookie(l,b,null,".huize.com"),this.loadComparePro(),!0)},cookieStr:function(a,b,c){var d=a.split(",");if(d=$.grep(d,function(a){return""!==a}),1===c){for(var e=0;e<d.length;e++)if(d[e]===b)return d.join(",");d.push(b)}else for(var e=0;e<d.length;e++)if(d[e]===b)return d.splice(e,1),d.join(",");return d.join(",")}},d.exports=n});