/**
 ** 
 ** www.huize.com; 
 ** Version:0.1.0;
 ** Last Updated:2016-08-09; 
 **
 **/
define(["jquery","underscore","helper","layer","my-calendar","jquery-prompt","fix-float","message","base"],function($,a,b,c,d,e,f,g,h){"use strict";var i,j,k=!1,l=new g,m=(new h,{init:function(){m.initData()},initData:function(){b.state.checkLogin(function(a){k=a.result,k?($("#logintips").html("页面提示购物车是空的，赶紧选购吧！"),$("#pingce").removeClass("fn-hide")):($("#tiplogin").removeClass("fn-hide"),$("#loginBtn").click(function(){requirejs(["sign-float"],function(a){new a({returnUrl:location.href,showRegister:!0,callback:function(a){location.reload()}});setTimeout(function(){$(".placeholder-text").css("top","0px")},500)})}),$("#registerBtn").click(function(){requirejs(["sign-float"],function(a){new a({returnUrl:location.href,showRegister:!0,defaultTab:2,callback:function(a){location.reload()}});setTimeout(function(){$(".placeholder-text").css("top","0px")},500)})}),$("#toLogin").removeClass("fn-hide")),require(["require-text!/html/shopping-cart/index.html"],function(a){i=a,m.refreshData()})}),m.getHistory()},refreshData:function(){var d=this;b.request.getJson({url:"/api/shopping-cart/list"},function(b){var c=j=b.result;if(c.length>0){$("#shopCartLoading").addClass("fn-hide"),$("#shopCarList").removeClass("fn-hide");var e="",g=0,h=[{cartItems:[],cartProjectPlans:[]}],k=[];if($(c).each(function(a){var b=this;if(b.cartProjectPlans.length>0){var c=!1,d=!1;$(b.cartItems).each(function(a){this.productOnline?this.isOver&&(d=!0):c=!0}),c?(k.push({cartProjectPlans:b.cartProjectPlans.concat(),cartItems:b.cartItems.concat()}),b.cartItems=[],b.cartProjectPlans=[],g++):d&&(k.unshift({cartProjectPlans:b.cartProjectPlans.concat(),cartItems:b.cartItems.concat()}),b.cartItems=[],b.cartProjectPlans=[],g++)}else $(b.cartItems).each(function(a){this.productOnline?this.isOver&&(h[0].cartItems.unshift(this),b.cartItems.splice(a,1),g++):(h[0].cartItems.push(this),b.cartItems.splice(a,1),g++)})}),k.length>0){var m,n=k.length;for(m=0;n>m;m++)h.push(k[m])}if(h.length>0){for(var m=0;m<h.length;m++){var o=h[m];o.cartItems.sort(function(a,b){return a.updateTime<b.updateTime?1:-1});var p=o.cartItems[0]?o.cartItems[0].updateTime:"0";o.updateTime=p}h.sort(function(a,b){return a.updateTime<b.updateTime?1:-1})}$("#carItemList").html(a.template(i.split("<area>")[0])({datas:c,OffLine:0})),$("#carItemList").append(a.template(i.split("<area>")[0])({datas:h,OffLine:g})),setTimeout(function(){$("#carItemList").addClass("temp-ie-fixed")},300);for(var m=0;m<c.length;m++)for(var q=0,r=c[m].cartItems.length,s=0;r>s;s++)e=c[m].cartItems[s],c[m].cartProjectPlans.length>0?d.renderProtectItem(c[m],"plan"):d.renderProtectItem(e),d.renderDateLimit(e),c[m].cartProjectPlans.length>0?(q+=c[m].cartItems[s].percentComplete,s===r-1&&q/r!==100&&$("i[rel=prompt_"+c[m].cartItems[0].id+"]").attr("data-prompt-html","投保信息填写不全，请先完善投保信息").prompt()):100!==c[m].cartItems[s].percentComplete&&$("i[rel=prompt_"+c[m].cartItems[s].id+"]").attr("data-prompt-html","投保信息填写不全，请先完善投保信息").prompt();for(var m=0;m<h.length;m++)for(var s=0;s<h[m].cartItems.length;s++)h[m].cartProjectPlans.length>0?d.renderProtectItem(h[m],"plan"):d.renderProtectItem(h[m].cartItems[s]),d.renderDateLimit(h[m].cartItems[s]);new f({el:$("#bottombar"),fixPanel:$("#carItemList"),fixClass:"fixed-insure-cart-foot",fixbuttom:!0})}else $("#carItemList").html(),$("#shopCarList").addClass("fn-hide"),$("#shopCartLoading").addClass("fn-hide"),$("#notLoginEmpty").removeClass("fn-hide");l.hide()},function(a){a.message&&c.msg(a.message)})},getDoubleNum:function(a){var b=a.split("-");return $.each(b,function(a){parseInt(b[a])<9&&(b[a]="0"+parseInt(b[a]))}),b.join("-")},renderDateLimit:function(a){var b,c=new Date,d=this,e=new Date,f=!1,g="",h=0,i=new Date,j=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate();if(a.productEffectiveDate?1===a.productEffectiveDate.effectiveType?(b=0===a.productEffectiveDate.effectiveStartDay?a.productEffectiveDate.deadline.split(":"):a.productEffectiveDate.nextDayDeadline.split(":"),(e.getHours()>b[0]||e.getHours()===~~b[0]&&e.getMinutes()>b[1])&&(h=1),c.setDate(e.getDate()+a.productEffectiveDate.effectiveStartDay+h),i.setDate(e.getDate()+a.productEffectiveDate.effectiveEndDay+h),f=!0,g=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()):2===a.productEffectiveDate.effectiveType?(g=a.productEffectiveDate.fixedEffectiveLatestDate.split("T")[0],f=!0):3===a.productEffectiveDate.effectiveType&&$("#txStartDate-"+a.id).html(a.productEffectiveDate.fixedEffectiveContent):(g=j,f=!0),f){var k=a.startDate&&a.startDate.split("T")[0];$("#txStartDate-"+a.id).html(k||d.getDoubleNum(g)||d.getDoubleNum(j))}},renderProtectItem:function(c,d){var d=d||"";if(d){if("plan"===d){var e=c.cartProjectPlans,f=e[0].protectItem,g=c.cartItems[0].id;if(""!==f){var h=JSON.parse(f);$("#protect_"+g).attr("data-prompt-html",a.template(i.split("<area>")[2])({protectItems:h})).prompt()}}}else{var j,k=c.restrictRule;k&&($.each(k.protectTrialItemList||[],function(){j=this.relateCoverageId;var a=this;j&&$.each(k.restrictGenes,function(){this.protectItemId===~~j&&(a.fullPremium=this.defaultValue)})}),$("#protect_"+c.id).attr("data-prompt-html",a.template(i.split("<area>")[1])({protectItems:b.utils.marginProtectList(k.protectTrialItemList)})).prompt())}},canlendarCallback:function(a,d){var e=this;"date"===d.type&&(l.show("正在加载...","loading"),b.request.postData2({url:"/api/insurance-slips/"+this.insureNum+"/start-date",data:{insureNum:this.insureNum,startDate:a},method:"PUT"},function(a){l.hide(),a.result?($(e.el).closest(".insure-cart-body").find(".checkItem").attr("over","false"),window.location.reload()):c.msg("更改起保日期失败！")}))},initReact:function(){$("#viewWraper").css("width",220*$("#viewWraper li").length+"px")},deleteInsure:function(a,d){var d=d||"",e="";if(e="plan"===d?"/api/shopping-cart/items?projectInsuranceGroup="+a+"&type="+d:"/api/shopping-cart/items?insuranceNum="+a,k)b.request.postData({url:e,method:"DELETE",data:{}},function(a){a.result?(c.msg("删除成功"),m.refreshData()):c.msg(a.message)});else{var f=b.cookie.getCookie("InsureNums");if("string"==typeof a)b.cookie.setCookie("InsureNums",f.replace(a+",","").replace(a,""),0,".huize.com");else{var g,h=a.length;for(g=0;h>g;g++)b.cookie.setCookie("InsureNums",f.replace(a[g]+",","").replace(a[g],""),0,".huize.com"),f=b.cookie.getCookie("InsureNums")}f.lastIndexOf(",")==f.length-1&&b.cookie.setCookie("InsureNums",f.substring(0,f.length-1),0,".huize.com"),m.refreshData()}},initAction:function(){var a=this;$("#shopCarList").on("click",".delBtn",function(){var b=this;c.confirm('<p class="pt45 pb45 tac">确认要从购物车中删除该产品吗？</p>',{btn:["取消","确定"],area:"530px",title:!1,btn1:function(){c.closeAll()},btn2:function(c){var d=$(b).attr("data-type")||"";if("plan"===d)if(k)a.deleteInsure($(b).attr("data-group"),d);else{var e=[];$(b).parents("ul").find("input[type=hidden]").each(function(){e.push($(this).attr("insurenum"))}),a.deleteInsure(e,d)}else a.deleteInsure($(b).attr("pid"))}})}).on("click","#checkAllCom",function(){var b="hz-check-item-checked";if($(this).hasClass(b))$(this).removeClass(b),$(".checkItem").removeClass(b);else{$(this).addClass(b),$(".checkItem").removeClass(b);var c=$(".checkItem[support='true']:not([over='true']):not([online='false'])"),d=c.length,e=!1,f=1;!function g(a){c.each(function(c){var f=$(this),h=f.attr("data-type")||"";return 1===a?"100"===f.attr("process")&&"plan"!==h&&(e=!0,f.addClass(b)):2===a?"100"===f.attr("process")&&(e=!0,f.addClass(b)):3===a?"plan"!==h&&(e=!0,f.addClass(b)):4===a&&(e=!0,f.addClass(b)),2!==a&&4!==a||"plan"!==h||!e?void(c!==d-1||e||(a++,g(a))):!1})}(f)}a.calPrice()}).on("click",".checkItem",function(){var d=$(this).attr("support"),e=$(this).attr("data-type")||"",f="hz-check-item-checked";if("plan"===e?$(this).hasClass(f)?($(this).removeClass(f),$("#checkAllCom").removeClass(f)):($(".checkItem").removeClass(f),$(this).addClass(f)):$(this).hasClass(f)?($(this).removeClass(f),$("#checkAllCom").removeClass(f)):("false"===d?$(".checkItem").removeClass(f):$(".checkItem[support='false']").removeClass(f),$('.checkItem[data-type="plan"]').removeClass(f),$(this).addClass(f)),$(this).attr("activeid")){var g=$(this).attr("activeid"),h=0,i=$("div.hz-check-item-checked[activeid='"+$(this).attr("activeid")+"']"),j=$("#actId_"+g).attr("minCount"),k=[];i.length>0?$("#tips_"+g).removeClass("fn-hide"):$("#tips_"+g).addClass("fn-hide"),i.each(function(a,b){var c=$(b).attr("data-type")||"";if("plan"===c){var d=$(b).find("input");d.length>0&&d.each(function(){h+=parseInt($(this).attr("premium")),k.push({insuranceNum:parseFloat($(this).attr("insurenum")),premium:parseFloat($(this).attr("premium"))})})}else h+=parseInt($(b).attr("premium")),k.push({insuranceNum:parseFloat($(b).attr("insurenum")),premium:parseFloat($(b).attr("premium"))})}),0>h-j?$("#tips_"+g).html("还差"+(j-h)/100):b.request.postData2({url:"/api/insurance-slips/amount/choosed",data:k},function(a){a.result&&$("#tips_"+g).html("已减"+(j-h)/100)},function(a){10302===a.status||10401===a.status?(c.msg(a.message),setTimeout(function(){location.reload()},5e3)):-2147483648===a.status&&c.msg(a.message)})}a.calPrice()}).on("click","#toPayAll",function(){var a=$("#carItemList .hz-check-item-checked");if(0===a.length)c.msg("请选择要支付的产品");else{l.show("结算中....","loading");var d=function(){var d=[],e="",f="",g="",h="",i="";return a.each(function(){var b=$(this),c=b.attr("data-type")||"";"plan"===c?(f=b.attr("data-title"),b.find("input").each(function(){d.push({insuranceNum:$(this).attr("insurenum"),premium:$(this).attr("premium")})})):(f=$("#name_"+b.attr("insureNum")).html(),d.push({insuranceNum:b.attr("insurenum"),premium:b.attr("premium")})),"true"===b.attr("over")?e=f+"产品已经过期，请修改起保日期后再结算":"false"===b.attr("online")&&(e=f+"产品已经下架，不能结算"),"100"!==b.attr("process")&&(i="您勾选的产品中有未填写完整的保单，请填写完再支付"),"2"===b.attr("payStatus")&&a.length>1&&(g="被保险人"+$("#"+b.attr("insurenum")+"_insurantName").html()+"保额达到保险公司规定的保额限制，请您单独提交结算",h=b.attr("insurenum"))}),e?void c.msg(e):i?void c.msg(i):g?void b.page.showSingleBtn('<p class="pt45 pb45 tac">'+g+"</p>"):(l.show("提交结算...","loading"),void b.request.postData2({url:"/api/orders/settlement",data:d},function(a){l.hide(),a.result.uuid&&(location.href="/orders/settlement/"+a.result.uuid)},function(a){10261===a.status?(l.show("部分投保单已结算，正在为您刷新页面","warning"),setTimeout(function(){location.reload()},5e3)):c.msg(a.message)}))};b.state.checkLogin(function(a){a.result?d():requirejs(["sign-float"],function(a){new a({returnUrl:location.href,showRegister:!0,callback:function(a){location.reload()}})}),l.hide()})}}).on("click","#toCompare",function(){var a,d=$(".hz-check-item-checked:not(#checkAllCom)"),e="",f=[],g=!1;if(d.each(function(b){a=$(this),-1===e.indexOf(a.attr("planId"))&&(f.push(a.attr("planId")),e+=a.attr("planId"));var d=a.attr("data-type")||"";return"plan"===d?(c.msg("规划不能进行对比"),g=!0,!1):void 0}),g)return!1;if(f.length<2)c.msg("至少选择两款产品");else if(f.length>4)c.msg("对比的产品不能超过四个");else{for(var h=f.length;4>h;h++)f.push("0");b.page.openNewTag("/contrast-"+f.join("-"))}}).on("click","a[hrefurl]",function(){var d=$(this),e=d.attr("insureNum"),f=d.attr("hrefurl"),g=d.attr("data-type")||"";b.request.getJson({url:"/api/insurance-slips/"+e+"/is-ready"},function(a){location.href=f},function(f){if(10401===f.status||10603===f.status)c.msg(f.message),setTimeout(function(){location.reload()},4e3);else if(10317===f.status){var h=d.closest(".insure-cart-body").find(".product-title a").attr("href");if("plan"===g){var i=d.attr("data-group")||"";b.page.showSingleBtn('<p class="pt45 pb45 tac">'+$("#name_"+e).html()+"产品试算信息发生变更，无法结算。需重新添加购物车哦~</p>",function(){a.deleteInsure(i,g),window.location.href=h},"删除并返回产品详情页")}else b.page.showSingleBtn('<p class="pt45 pb45 tac">'+$("#name_"+e).html()+"产品试算信息发生变更，无法结算。需重新添加购物车哦~</p>",function(){a.deleteInsure(e),window.location.href=h},"删除并返回产品详情页")}else b.page.showSingleBtn('<p class="pt45 pb45 tac">'+f.message+"</p>",function(){},"知道了")})}),$("#historyData").on("click","#nextBtn",function(){if(!($("#viewWraper li").length<5)){var a=$("#viewContainer ul").width(),b=$("#viewContainer").scrollLeft(),c=$("#viewContainer").width(),d=b>a?$("#viewContainer ul").eq(0):[];2*a-b===c&&($("#historyViewWrap ul").eq(0).remove(),$("#viewContainer").scrollLeft(b-a),$("#historyViewWrap").append(d)),b=$("#viewContainer").scrollLeft(),$("#viewContainer").scrollLeft(b+220)}}).on("click","#prevBtn",function(){if(!($("#viewWraper li").length<5)){var a=$("#viewContainer ul").width(),b=$("#viewContainer").scrollLeft(),c=$("#viewContainer").width(),d=$("#viewContainer ul").eq(1);b===c&&($("#historyViewWrap ul").eq(1).remove(),$("#viewContainer").scrollLeft(b+a),d.insertBefore($("#historyViewWrap ul"))),b=$("#viewContainer").scrollLeft(),$("#viewContainer").scrollLeft(b-220)}}),$("#notLoginEmpty").on("click","#toLogin",function(){requirejs(["sign-float"],function(a){new a({returnUrl:location.href,showRegister:!0,callback:function(a){location.reload()}})})})},calPrice:function(){for(var a=$("#carItemList .hz-check-item-checked"),d=[],e=0,f=0;f<a.length;f++){var g=$(a[f]).find("input");if(g.length>0)for(var h=0,i=g.length;i>h;h++){var j=g.eq(h);d.push({insuranceNum:parseFloat(j.attr("insurenum")),premium:parseFloat(j.attr("premium"))}),e+=j.attr("originalPrice")-j.attr("premium")}else d.push({insuranceNum:parseFloat($(a[f]).attr("insurenum")),premium:parseFloat($(a[f]).attr("premium"))}),e+=$(a[f]).attr("originalPrice")-$(a[f]).attr("premium")}$("#checked").html(a.length),d.length>0?b.request.postData2({url:"/api/insurance-slips/amount/choosed",data:d},function(a){a.result&&($("#totalMoney").html(((a.result.totalPremium-a.result.totalDiscount)/100).toFixed(2)),$("#saveMoney").html((e/100).toFixed(2)))},function(a){10302===a.status||10401===a.status?(c.msg(a.message),setTimeout(function(){location.reload()},5e3)):10317===a.status?b.page.showSingleBtn(a.message,function(){m.deleteInsure()}):-2147483648!==a.status&&10305!==a.status||c.msg(a.message)}):($("#totalMoney").html("0.00"),$("#saveMoney").html("0.00"))},getHistory:function(){var c=b.cookie.getCookie("Product_History"),d=c.split(","),e=[];d=$.grep(d,function(a){return""!==a}),$.each(d,function(a){this.split(":")[1]&&e.push(this.split(":")[1])}),b.request.postData2({url:"/api/products/plans/list",data:e},function(b){require(["require-text!/html/shopping-cart/product-history.html"],function(c){if(b.result.length){var d=$(a.template(c)({datas:b.result})),e=d.find("li").length,f=220*e,g=e>5?d.width(f).css("float","left").clone().attr("id","historyListClone"):"",h=$("<div id='historyViewWrap'></div>").append(d).append(g).width(f*(e>5?2:1));$("#viewContainer").html(h).scrollLeft(f),5>=e&&$("#prevBtn,#nextBtn").addClass("view-history-scroll-prev-disabled")}else $("#historyPanel").hide(),$("#emptyData").show()})}),m.initAction()}});return m});