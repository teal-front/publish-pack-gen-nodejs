/**
 ** 
 ** www.huize.com; 
 ** Version:0.1.0;
 ** Last Updated:2016-08-09; 
 **
 **/
define(["jquery-tab","layer","helper"],function(a,b,c){"use strict";var d={init:function(){this.initData(),this.render(),this.initEvents()},render:function(){$("#kfLink").attr("href","http://kefu.hzins.com/chat?domain=hzins&businessType=Xm4FWr0dncw&referrer="+encodeURIComponent(window.location.href)),b.alert2=function(){b.alert.apply(this,arguments),$(".layui-layer-btn0").removeClass("layui-layer-btn0").addClass("layui-layer-btn1")}},initData:function(){var a=this.data,b=window.pageData||{};a.orderNum=b.orderNum||"",a.totalBuyPrice=b.totalBuyPrice||0,a.totalDiscount=b.totalDiscount||0,a.totalPayable=b.totalPayableAmount||0,a.gatewayId=(b.gateways||{}).lastGatewayCode||"",a.bankId=(b.gateways||{}).lastBankId||""},data:{orderNum:"",totalBuyPrice:0,totalDiscount:0,totalPayable:0,gatewayId:"",gatewayName:"",bankId:"",wxTimer:null},initEvents:function(){$("#toggleProductDetail").click(function(){$(this).toggleClass("show-detail"),$(".checkout-product-dropdown").toggle()}),$("#payTypeMenu").tab("#payTypeContent",{titleCurrent:"active",contentCurrent:"show"}),$("#payTypeContent .hz-radio-item").click(function(){d.command.paymentTypeSelect.call(this)}),$("#submitGatewayPayment").click(function(){21===d.data.gatewayId&&d.command.pollingPaymentStatus(),21!==d.data.gatewayId&&(d.data.newWindow=window.open()),d.command.submitGatewayPayment.call(this,function(a){return 21===d.data.gatewayId?(a.result||b.msg("获取不到二维码"),void setTimeout(function(){$("#wechatPayment .qr-code-img").attr("src",a.result),b.open({type:1,title:!1,area:"870px",content:$("#wechatPayment")})},300)):(d.data.wxTimer&&(clearInterval(d.data.wxTimer),d.data.wxTimer=null),void(""!==a.result?($("#gatewayName").text(d.data.gatewayName),b.open({type:1,title:!1,area:"870px",shadeClose:!0,content:$("#paymentHelp")}),d.data.newWindow.location.href="/orders/payment-transfer?id="+a.result):(b.msg("支付失败"),d.data.newWindow&&d.data.newWindow.close())))})}),$(".other-payment-type").click(function(){$(this).closest(".layui-layer").find(".layui-layer-close").trigger("click")}),$("#morePaymentType").click(function(){$("#allPaymentType").show(),$("#lastPaymentType").hide()}),$("#completedPayment").click(function(){d.command.getPaymentStatus(function(a){switch(a){case 1:b.msg("未支付");break;case 2:b.msg("付款中");break;case 3:b.msg("支付失败");break;case 4:window.location.href="/orders/payment-success?orderNum="+d.data.orderNum;break;case 5:b.msg("已取消");break;case 10:b.msg("已删除");break;default:b.msg("未支付")}window.setTimeout(function(){window.location.reload()},1e3)})}),$("#otherPaymentType").click(function(){d.command.getPaymentStatus(function(a){4===a?window.location.href="/orders/payment-success?orderNum="+d.data.orderNum:window.location.reload()})}),$(".help-link").click(function(){$(".payment-help").toggle(),$(this).toggleClass("show-detail")})},command:{paymentTypeSelect:function(){var a=$(this).data("checked"),b="",c="",e=d.data;a!==!0&&($("#payTypeContent .hz-radio-item").data("checked",!1).removeClass("hz-radio-item-checked"),$(this).data("checked",!0).addClass("hz-radio-item-checked"),b=$(this).data("gateway-code"),c=$(this).data("bankid"),b=void 0!==c?1:b,e.gatewayId=b,e.gatewayName=$(this).find("img").attr("alt"),e.bankId=c||"")},submitGatewayPayment:function(a){var e=d.data;if(!e.submitLocked){if(e.submitLocked=!0,""===e.gatewayId)return void b.msg("请选择支付方式");var f={url:"/api/orders/payment/gateway",data:{orderNum:e.orderNum,totalBuyPrice:e.totalBuyPrice,totalDiscount:e.totalDiscount,totalPayable:e.totalPayable,gatewayId:e.gatewayId},async:!1},g=function(b){"function"==typeof a&&a(b),e.submitLocked=!1},h=function(a){d.data.newWindow&&d.data.newWindow.close(),e.submitLocked=!1;var c=a.status,f=a.message||"系统错误，无法提交";e.orderNum;if(c)switch(c){case"00001":requirejs(["sign-float"],function(a){new a({returnUrl:location.href,showRegister:!0,callback:function(a){location.reload()}})});break;case 10253:case 10401:case 36057:case 10311:case 37111:case 10602:case 10276:case 10254:case 5:case 4:b.alert2(f,{btn:["知道了"]},function(){var a={url:"/api/orders/"+e.orderNum,type:"PUT",success:function(){window.location.href="http://i.huize.com/"}};$.ajax(a)});break;case 10260:b.confirm('<div class="pt45 pb45 tac">'+f+"</div>"||"系统错误",{title:!1,btn:["知道了"]},function(a){window.location.reload(),b.close(a)});break;case 37115:case 37120:b.confirm('<div class="pt45 pb45 tac">'+f+"</div>",{btn:["查看订单","联系客服"],title:!1,area:"530px"},function(a){b.close(a);var c=window.open("about:blank");c.location.href="http://i.huize.com/Order/Detail?orderNum="+e.orderNum},function(a){var c=window.open("about:blank");c.location.href="http://kefu.hzins.com/chat?domain=hzins&businessType=Xm4FWr0dncw&referrer="+encodeURIComponent(window.location.href),b.close(a)});break;case 10003:b.confirm('<div class="pt45 pb45 tac">'+f+"</div>",{btn:["取消","确认"],title:!1,area:"530px"},function(a){b.close(a)},function(a){window.location.href="http://passport.huize.com/SignIn/Quit?returnurl="+window.location.href,b.close(a)});break;default:b.confirm('<div class="pt45 pb45 tac">'+f+"</div>"||"系统错误",{title:!1,btn:["知道了"]},function(a){var c={url:"/api/orders/"+e.orderNum,type:"PUT",success:function(){window.location.href="http://i.huize.com/"}};$.ajax(c),b.close(a)})}else;};""!==e.bankId&&(f.data.bankId=e.bankId),c.request.postData2(f,g,h)}},getPaymentStatus:function(a){var b={url:"/api/orders/"+d.data.orderNum+"/detail"},e=function(b){a(b.result.status||1)};c.request.getJson(b,e)},pollingPaymentStatus:function(){var a=d.data;null===a.wxTimer&&(a.wxTimer=window.setInterval(function(){d.command.getPaymentStatus(function(a){switch(a){case 3:b.msg("支付失败");break;case 4:window.location.href="/orders/payment-success?orderNum="+d.data.orderNum;break;case 5:b.msg("已取消");break;case 10:b.msg("已删除")}})},1e3))}}};return d});