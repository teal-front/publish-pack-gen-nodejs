/**
 ** 
 ** www.huize.com; 
 ** Version:0.1.0;
 ** Last Updated:2016-08-09; 
 **
 **/
define(["layer","helper","underscore","jquery-prompt","message"],function(a,b,c,d,e){var f={init:function(){this.initData(),this.render(),this.initEvent()},render:function(){a.alert2=function(){a.alert.apply(this,arguments),$(".layui-layer-btn0").removeClass("layui-layer-btn0").addClass("layui-layer-btn1")},this.command.initExceptions();var b=this.data,c=$("#beanPay").closest(".confirm-order-operate-item");this.command.bindBalanceBeanAmount.call(c,3,!0);var d=$("#balancePay").closest(".confirm-order-operate-item");this.command.bindBalanceBeanAmount.call(d,1,!0),0===b.frozenAmount.redEnvelope.length&&0===b.ableAmount.redEnvelope.length,$("#shipPayment")[this.data.isShowShipAddress&&this.data.totalPremium<3e4?"show":"hide"](),$("#sendMessage")[this.data.isShowShipAddress?"show":"hide"](),this.command.bindTotalPremium(),this.command.message=new e,this.data.submitLocked=!1},initData:function(){var a=this.data;$("#insureList tr[data-insurenum]").each(function(){var b=$(this).find("[data-policy-selected]").data("policy-selected");a.insureNumList.push({insuranceNum:$(this).data("insurenum"),needPaper:2===+b||3===+b,premium:Math.round(100*$(this).find(".primary-color").text()||0)}),a.planIds.push($(this).data("planid"))});var b=userData||[];$.each((b.accountBalanceInfo||{}).accountBalances||[],function(a,c){1001===c.currencyId?c.currentAmount=b.paymentCombinationVerificationResult.maxBalanceAmount:1003===c.currencyId&&(c.currentAmount=b.paymentCombinationVerificationResult.maxGolderBeanAmount)}),this.command.refreshBalancesBeanRedEnvelope(b.accountBalanceInfo||{});var d=((b||{}).paymentCombinationVerificationResult||{}).bestRedEnvelope||{},e=d.voucherSerialNo||"";""!==e&&(this.data.alreadyUsedAmount.redEnvelope.voucherSerialNo=e,this.data.alreadyUsedAmount.redEnvelope.discountRedEnvelope=((c.filter(b.accountBalanceInfo.accountRedEnvelopeInfo.availableRedEnvelopes,function(a){return a.voucherSerialNo===e})||[])[0]||{}).amount||0,this.data.alreadyUsedAmount.redEnvelope.discountRedEnvelope=(b.paymentCombinationVerificationResult.bestRedEnvelope||{}).amount||0),this.data.totalPremium=b.totalPremium||0,this.data.totalDiscount=b.totalDiscount||0,this.data.totalPayableAmount.redEnvelope=b.discountRedEnvelope||d.amount||0,this.data.shipAddress=b.shipAddress||{},this.data.shipPayAmount=1500,this.data.paymentType=b.paymentType||2,this.data.isShowShipAddress=b.showShipAddress,this.command.getUserAddress(),this.data.insuranceResults=b.insuranceResults||[];var f=/\?orderNum=(\d+)&?/gi.exec(window.location.href);f=f?f[1]:null,this.data.orderNum=f},data:{insureNumList:[],planIds:[],postAddress:{},totalPremium:0,ableAmount:{bean:0,balance:0,redEnvelope:[]},currentAbleAmount:{bean:0,balance:0},frozenAmount:{bean:0,balance:0,redEnvelope:[]},shipPayAmount:0,frozenAccountBalances:{bean:[],balance:[]},alreadyUsedAmount:{bean:"",redEnvelope:{voucherSerialNo:"",discountRedEnvelope:0}},totalGatewayPay:0,totalDiscount:0,totalPayableAmount:{bean:0,balance:0,redEnvelope:0},blurInput:[],blurInputOldValue:0,shipAddress:{},isShowShipAddress:!0,submitLocked:!1},template:{balanceBeanTpl:"",redEnvelopeTpl:""},command:{message:{},initExceptions:function(){var a=f.data.insuranceResults[0]||{};f.command.handlingExceptions(a,0)},initPaymentCombination:function(){var a=/\?orderNum=(\d+)&?/gi.exec(window.location.href),b=f.data;a=a?a[1]:null,a&&(b.orderNum=a,f.command.checkInputPaymentInfos(function(a){var c=$("#redEnvelopePay").hasClass("hz-check-item-checked"),d=a.result||{},e=(d.bestRedEnvelope||{}).voucherSerialNo||"";e?(b.ableAmount.redEnvelope=(d.accountRedEnvelopeInfo||{}).availableRedEnvelopes||[],b.frozenAmount.redEnvelope=(d.accountRedEnvelopeInfo||{}).frozenRedEnvelopes||[],f.command.bindRedEnvelope(e,c)):($("#redEnvelopePay").removeClass("hz-check-item-checked"),b.totalPayableAmount.redEnvelope=0)},function(){}))},handlingExceptions:function(b,c){var d=b.errorCode,e=b.errorMsg||"系统错误",f=void 0===c?1:c;if(d)switch(d){case"00001":requirejs(["sign-float"],function(a){new a({returnUrl:location.href,showRegister:!0,callback:function(a){location.reload()}})});break;case 10254:case 10253:case 10401:case 36057:case 10311:case 37111:case 10317:case 10602:case 1:a.alert2('<div class="pt45 pb45 tac">'+e+"</div>",{btn:["知道了"],closeBtn:f,area:"530px",title:!1},function(){window.location.href="/shopping-cart"});break;case 37115:case 37120:a.confirm('<div class="pt45 pb45 tac">'+e+"</div>",{btn:["返回购物车","联系客服"],title:!1,closeBtn:f,area:"530px"},function(b){a.close(b);var c=window.open("about:blank");c.location.href="/shopping-cart"},function(b){var c=window.open("about:blank");c.location.href="http://kefu.hzins.com/chat?domain=hzins&businessType=Xm4FWr0dncw&referrer="+encodeURIComponent(window.location.href),a.close(b)});break;case 10003:a.confirm('<div class="pt45 pb45 tac">'+e+"</div>",{btn:["取消","确认"],title:!1,area:"530px"},function(b){a.close(b)},function(b){window.location.href="http://passport.huize.com/SignIn/Quit?returnurl="+window.location.href,a.close(b)});break;case 10102:a.alert2('<div class="pt45 pb45 tac">'+e+"</div>",{btn:["知道了"],title:!1,closeBtn:f,area:"530px"},function(b){a.close(b)});break;default:a.alert2('<div class="pt45 pb45 tac">'+e+"</div>",{btn:["知道了"],title:!1,closeBtn:f,area:"530px"},function(){window.location.href="/shopping-cart"})}},getUserAddress:function(){var a={url:"/api/users/addresses"},c=function(a){var c=f.data.shipAddress=a.result||{};c=a.result||{},b.request.getJson({url:"/api/tools/address/province"},function(a){var d=a.result,e="",f="";$.each(d,function(a,d){+d.provinceCode===+c.provinceCode&&(e=d.name,b.request.getJson({url:"/api/tools/address/city?province="+c.provinceCode},function(a){var d=a.result||{},g="";$.each(d,function(a,d){return+d.cityCode===+c.cityCode||+d.cityCode===+c.provinceCode?(g=d.name,"810000"==c.provinceCode||82e4==c.provinceCode?void $("#sendMessage .send-add").text((e==g?e:e+g)+f+c.address):void b.request.getJson({url:"/api/tools/address/district?city="+($.trim(c.cityCode)||c.provinceCode)},function(a){var b=a.result;$.each(b,function(a,b){return+b.districtCode===+c.districtCode?(c.disdistrictName=f=b.name,void $("#sendMessage .send-add").text((e==g?e:e+g)+f+c.address)):void 0})})):void 0})}))})}),$("#sendMessage .send-user").text(c.name),$("#sendMessage .send-tel").text(c.mobileNo)};b.request.getJson(a,c)},linkAddress:function(){var a=f.data,b={province:a.shipAddress.provinceCode,city:a.shipAddress.cityCode,district:a.shipAddress.districtCode,fullAddress:a.shipAddress.address,username:a.shipAddress.name,phone:a.shipAddress.mobileNo},d={province:"",city:"",district:""},e=this.bindAddressSelect,g={province:"/api/tools/address/province",city:"/api/tools/address/city?province=",district:"/api/tools/address/district?city="},h=["120000","110000","310000","500000"],i=["810000","820000"];void 0===c.find(c.union(h,i),function(a){return+a===+b.province})&&($("#citySelect").show(),$("#areaSelect").show()),e(g.province,"#provinceSelect","省份/自治区",function(a){return $("#areaSelect .hz-dropdown-menu").empty(),$("#areaSelect .input-select-text").val("区/县"),void 0!==c.find(h,function(b){return+b===+a.provinceCode})?($("#citySelect").hide().find(".input-select-text").val("城市/地区"),e(g.district+(a.provinceCode||"00000"),"#areaSelect","区/县",function(a){}),void $("#areaSelect").show()):void 0!==c.find(i,function(b){return+b===+a.provinceCode})?($("#areaSelect").hide().find(".input-select-text").val("区/县"),e(g.city+(a.provinceCode||"00000"),"#citySelect","区/县",function(a){}),void $("#citySelect").show()):($("#citySelect").show(),$("#areaSelect").show(),void e(g.city+(a.provinceCode||"00000"),"#citySelect","城市/地区",function(a){e(g.district+(a.cityCode||"00000"),"#areaSelect","区/县",function(a){})}))},function(c){$.isEmptyObject(b)||void 0===b.province||+b.province===+c.provinceCode&&(d.province=c.name,$.trim(b.city)||($("#citySelect").hide(),e(g.district+(b.province||""),"#areaSelect",a.shipAddress.disdistrictName,function(a){})),$.trim(b.district)||$("#areaSelect").hide(),e(g.city+c.provinceCode,"#citySelect",b.city,function(a){e(g.district+(a.cityCode||""),"#areaSelect","区/县",function(a){})},function(a){+a.cityCode===+b.city&&e(g.district+(a.cityCode||"00000"),"#areaSelect",b.district||"区/县"),$("#provinceSelect").find(".input-select-text").val(d.province).attr("selected-code",b.province)}))}),b.province||$("#provinceSelect").find(".input-select-text").val("省份/自治区"),b.city||$("#citySelect").find(".input-select-text").val("城市/地区"),b.district||$("#areaSelect").find(".input-select-text").val("区/县"),void 0!==b.fullAddress&&$("#mailingAddressDialog textarea[name='fullAddress']").val(b.fullAddress),void 0!==b.username&&$("#mailingAddressDialog input[name='addressee']").val(b.username),void 0!==b.phone&&$("#mailingAddressDialog input[name='phone']").val(b.phone),""===b.fullAddress&&$("#mailingAddressDialog textarea[name='fullAddress']").siblings(".placeholder-text").show(),""===b.username&&$("#mailingAddressDialog input[name='addressee']").siblings(".placeholder-text").show(),""===b.phone&&$("#mailingAddressDialog input[name='phone']").siblings(".placeholder-text").show()},bindAddressSelect:function(a,c,d,e,f){var g=$(document.createDocumentFragment());b.request.getJson({url:a},function(a){var b=(a||{}).result||[],h=d;$.each(b,function(a,b){!/^\d+$/.test(d)||+b.cityCode!==+d&&+b.districtCode!==+d||(h=b.name),$("<li class='hz-select-option'> "+b.name+"</li>").data("item",b).appendTo(g),"function"==typeof f&&f.call(null,b)}),$(c).delegate(".hz-select-option","click",function(){"function"==typeof e&&e.call($(this),$(this).data("item"))}),$(c).find(".input-select-text").val(h).attr("selected-code",d),$(c).find(".hz-dropdown-menu").empty().append(g)})},toggleSelectPayment:function(a){var b="",c=f.command;switch(a){case 1:b="balance";break;case 2:b="redEnvelope";break;case 3:b="bean"}var d=f.data,e=(0===d.frozenAmount.redEnvelope.length&&0===d.ableAmount.redEnvelope.length,0===d.frozenAmount[b]&&0===d.ableAmount[b]);if((1===a||3===a)&&e)return!1;$(this).toggleClass("hz-check-item-checked"),d.pushAmountType=a;var g=$(this).parent().find(".have-value,#redEnvelope"),h=$(this);g.css("visibility","hidden"===g.css("visibility")?"visible":"hidden");var i=$(this).parent().find(".discount-pay-input"),j=!$(this).hasClass("hz-check-item-checked");if(j&&($(this).data("amount",d.totalPayableAmount[b]),d.totalPayableAmount[b]=0,i.val(""),2===a&&(d.alreadyUsedAmount.redEnvelope.voucherSerialNo="",d.totalPayableAmount.redEnvelope=0),c.bindTotalPremium()),2===a)d.needRedEnvelope=!0,$(this).hasClass("hz-check-item-checked")&&($("#redEnvelope").hide(),0===$(this).parent().find(".small-loading").length&&$(this).parent().append("<span class='small-loading fcc'>正在加载...</span>"),c.useRedEnvelope(d.alreadyUsedAmount.redEnvelope.voucherSerialNo,d.totalPayableAmount.redEnvelope,!0));else{if(j||($(this).siblings("div").find(".have-value").css("display","none"),0===$(this).siblings("div").find(".small-loading").length&&$(this).siblings("div").append("<span class='small-loading fcc'>正在加载...</span>")),0===d.ableAmount[b])return h.siblings("div").find(".small-loading").remove(),h.siblings("div").find(".have-value").css("display","inline-block"),!1;c.checkBalanceBean.call($(this).siblings("div").find(".discount-pay-input"),a,function(e){d.totalPayableAmount[b]=e,0!==+e||h.hasClass("hz-check-item-checked")?(i.val(1===a?(e/100).toFixed(2):e),d.ableAmount[1===a?"balance":"bean"]>0&&i.parent().append("<span class='discount-amount-value pl5'>-￥"+(e/100).toFixed(2)+"</span>")):i.val(""),d.ableAmount[1===a?"balance":"bean"]>0&&i.show(),setTimeout(function(){h.siblings("div").find(".small-loading").remove(),h.siblings("div").find(".have-value").css("display","inline-block")},300),c.bindTotalPremium()},!0)}},refreshBalancesBeanRedEnvelope:function(a){if(a&&!$.isEmptyObject(a)&&0!==a.accountBalances.length){var b=f.data;b.ableAmount.redEnvelope=(a.accountRedEnvelopeInfo||{}).availableRedEnvelopes,b.frozenAmount.redEnvelope=(a.accountRedEnvelopeInfo||{}).frozenRedEnvelopes,$.each(a.accountBalances,function(a,c){1001===+c.currencyId?(b.ableAmount.balance=c.amount,b.currentAbleAmount.balance=c.currentAmount||0,b.frozenAmount.balance=c.frozenAmount,b.frozenAccountBalances.balance=c.frozenAccountBalances):1003===+c.currencyId&&(b.ableAmount.bean=c.amount,b.currentAbleAmount.bean=c.currentAmount||0,b.frozenAmount.bean=c.frozenAmount,b.frozenAccountBalances.bean=c.frozenAccountBalances)})}},bindBalanceBeanAmount:function(a){if(1===a||3===a){var b,d=$(this),e=d.find(".hz-check-item"),g=d.find(".discount-pay-input"),h=f.data,i=1===a?"balance":"bean",j={amount:h.ableAmount[i],frozenAmount:h.frozenAmount[i],frozenAccountBalances:h.frozenAccountBalances[i],type:a},k=f.template;if(b=h.currentAbleAmount[i]||0,!$.isEmptyObject(j)){if(j.amount<=0&&j.frozenAmount<=0)e.find('[rel="prompt"]').prompt(),e.removeClass("hz-check-item-checked");else if(j.amount<=0&&j.frozenAmount>0||0>=b){e.find(".hz-check-icon").unbind("mouseenter"),e.removeClass("hz-check-item-checked");var l=$(this).find(".have-value,#redEnvelope");l.css("visibility","hidden"===l.css("visibility")?"visible":"hidden")}else e.find(".hz-check-icon").unbind("mouseenter"),e.addClass("hz-check-item-checked");j.amount>0&&(0===d.find(".hz-check-item-checked").length?g.val("").show():g.val(1===a?(b/100).toFixed(2):b).show()),1===a?h.totalPayableAmount.balance=Math.round(100*g.val())||0:h.totalPayableAmount.bean=g.val()||0,j.has=j.amount,j.discountAmount=h.totalPayableAmount[i],function(a){require(["require-text!/html/pay/balance-bean.html"],function(b){k.balanceBeanTpl=b;var e=c.template(b)(a);d.find(".have-value span,.have-value div").remove(),d.find(".have-value").append($(e))})}(j)}}},editAmount:function(a){var b=$(this).closest("li"),d=f.data,e=f.template,g={amount:1===a?d.ableAmount.balance:d.ableAmount.bean,frozenAmount:1===a?d.frozenAmount.balance:d.frozenAmount.bean,frozenAccountBalances:d.frozenAccountBalances[1===a?"balance":"bean"],has:!1,type:a};if(e.balanceBeanTpl){var h=c.template(e.balanceBeanTpl)(g);b.find(".have-value span,.have-value div").remove(),b.find(".have-value").append($(h))}},checkBalanceBean:function(b,c,d){var e=$(this),g=f.data,h=f.command;e.val()>g.ableAmount[1===b?"balance":"bean"]&&e.val(g.ableAmount[1===b?"balance":"bean"]);var i=function(f){var i=(f||{}).result||{},j=0,k=i.bestRedEnvelope||{},l=k.voucherSerialNo||"",m=function(a){g.alreadyUsedAmount.redEnvelope.voucherSerialNo=l,g.totalPayableAmount.redEnvelope=k.amount||0,g.ableAmount.redEnvelope=(i.accountRedEnvelopeInfo||{}).availableRedEnvelopes||[],g.frozenAmount.redEnvelope=(i.accountRedEnvelopeInfo||{}).frozenRedEnvelopes||[];var f=$("#redEnvelopePay").hasClass("hz-check-item-checked"),m=i[1===b?"maxBalanceAmount":"maxGolderBeanAmount"]||0;h.bindRedEnvelope(l,f),$("#redEnvelopePay").hasClass("hz-check-item-checked")||(g.alreadyUsedAmount.redEnvelope.voucherSerialNo="",g.totalPayableAmount.redEnvelope=0),j=!a&&d?m:e.val(),j>m&&(j=m,e.val(1===b?j/100:j)),g.totalPayableAmount[1===b?"balance":"bean"]=1===b?Math.round(100*j):j,g.ableAmount[1===b?"balance":"bean"]>0&&e.siblings().remove(),c(j)},n=function(b,c,d){a.confirm('<div class="pt45 pb45 tac">'+b+"</div>",{title:!1,area:"530px",btn:["取消","确定"]},function(b){e.val(g.blurInputOldValue||0).siblings().remove(),e.parent().append($("<span class= 'discount-amount-value'></span>").text("-￥"+(g.blurInputOldValue/100).toFixed(2))),g.totalPayableAmount.bean=g.blurInputOldValue||0,a.close(b)},function(b){c&&($.isEmptyObject(k)&&$("#redEnvelopePay").removeClass("hz-check-item-checked"),g.totalPayableAmount.redEnvelope=k.amount||0,g.alreadyUsedAmount.redEnvelope.discountRedEnvelope=k.amount||0,g.alreadyUsedAmount.redEnvelope.voucherSerialNo=l||""),d&&(o||$("#balancePay").removeClass("hz-check-item-checked").siblings("div").find(".have-value").css("visibility","hidden"),$("#balancePaymentInput").val((o/100).toFixed(2)),$(".balance-amount-pay .discount-amount-value").text("-￥"+(o/100).toFixed(2)),g.totalPayableAmount.balance=o),a.close(b),m()})};if(1===b&&Math.round(100*Number(e.val()||0))>i.maxBalanceAmount&&$("#balancePay").hasClass("hz-check-item-checked"))a.alert2("余额使用超过总保费金额，请确认后再修改",function(b){e.val(i.maxBalanceAmount/100),m(),a.close(b)});else if(3===b){var o=f.result.maxBalanceAmount||0;g.totalPayableAmount.redEnvelope>0&&$.isEmptyObject(k)&&g.totalPayableAmount.balance>o?($.isEmptyObject(k)&&$("#redEnvelopePay").removeClass("hz-check-item-checked"),g.totalPayableAmount.redEnvelope=k.amount||0,g.alreadyUsedAmount.redEnvelope.discountRedEnvelope=k.amount||0,g.alreadyUsedAmount.redEnvelope.voucherSerialNo=l||"",o||$("#balancePay").removeClass("hz-check-item-checked").siblings("div").find(".have-value").css("visibility","hidden"),$("#balancePaymentInput").val((o/100).toFixed(2)),$(".balance-amount-pay .discount-amount-value").text("-￥"+(o/100).toFixed(2)),g.totalPayableAmount.balance=o,m()):g.totalPayableAmount.balance>o?(o||$("#balancePay").removeClass("hz-check-item-checked").siblings("div").find(".have-value").css("visibility","hidden"),$("#balancePaymentInput").val((o/100).toFixed(2)),$(".balance-amount-pay .discount-amount-value").text("-￥"+(o/100).toFixed(2)),g.totalPayableAmount.balance=o,m()):g.totalPayableAmount.redEnvelope>(k.amount||0)?n("使用金豆超过红包满减条件后，将无法使用红包",!0,!1):m()}else m();g.blurInput="",h.unlockSubmitPayment()},j=function(c){g.blurInput=[],h.unlockSubmitPayment(),a.msg(c.message||"验证失败"),e.val(1===b?"0.00":"0")};h.checkInputPaymentInfos(i,j)},bindRedEnvelope:function(a,b){var d=f.data,e=f.command,g={availableRedEnvelopes:d.ableAmount.redEnvelope,frozenRedEnvelopes:d.frozenAmount.redEnvelope,bestRedEnvelope:a,show:void 0===b?!0:b};g.haveRedEnvelope=!(0===g.availableRedEnvelopes.length&&0===g.frozenRedEnvelopes.length),g.discountRedEnvelope=(c.filter(g.availableRedEnvelopes,function(b){return b.voucherSerialNo===a})[0]||{}).amount||0,e.renderRedEnvelope(g)},renderRedEnvelope:function(a){var b=function(b){var d=c.template(b)(a);$("#redEnvelope").remove(),$("#redEnvelopePay").parent().append($(d))},d=f.data,e=f.template;return 0===d.frozenAmount.redEnvelope.length&&0===d.ableAmount.redEnvelope.length||$(".red-envelope-pay i[rel='prompt']").unbind("mouseenter"),""===e.redEnvelopeTpl?void require(["require-text!/html/pay/red-envelope.html"],function(a){e.redEnvelopeTpl=a,b(a)}):void b(e.redEnvelopeTpl)},bindTotalPremium:function(){var a=f.data,b=a.totalPremium-a.totalPayableAmount.bean-a.totalPayableAmount.redEnvelope-a.totalDiscount;b=Number(0>b?0:b),b=a.totalPremium>=3e4?b-a.totalPayableAmount.balance:b+Number(a.isShowShipAddress?a.shipPayAmount:0)-a.totalPayableAmount.balance,b=Number(0>b?0:b),$("#payTypeSelect")[0>=b?"hide":"show"](),a.totalGatewayPay=0>b?0:b,$("#totalPayableAmount").text((a.totalGatewayPay/100).toFixed(2)),$("#beanTotalPayment .total-value").text("-￥"+(a.totalPayableAmount.bean/100).toFixed(2)),$("#redEnvelopeTotalPayment .total-value").text("-￥"+(a.totalPayableAmount.redEnvelope/100).toFixed(2)),$("#balanceTotalPayment .total-value").text("-￥"+(a.totalPayableAmount.balance/100).toFixed(2)),$("#beanTotalPayment")[$("#beanPay").hasClass("hz-check-item-checked")?"removeClass":"addClass"]("fn-hide"),$("#redEnvelopeTotalPayment")[$("#redEnvelopePay").hasClass("hz-check-item-checked")?"removeClass":"addClass"]("fn-hide"),$("#balanceTotalPayment")[$("#balancePay").hasClass("hz-check-item-checked")?"removeClass":"addClass"]("fn-hide")},useRedEnvelope:function(b,d,e){var g=f.data,h=f.command,i=function(f){var i=f.result.bestRedEnvelope||{},j=f.result.maxBalanceAmount,k=function(){var a;g.alreadyUsedAmount.redEnvelope.voucherSerialNo=i.voucherSerialNo||b,g.totalPayableAmount.redEnvelope=d=(c.find(g.ableAmount.redEnvelope,function(a){return a.voucherSerialNo===(i.voucherSerialNo||b)})||{}).amount||0,g.alreadyUsedAmount.redEnvelope.discountRedEnvelope=d,h.bindTotalPremium(),a={discountRedEnvelope:d,availableRedEnvelopes:g.ableAmount.redEnvelope,frozenRedEnvelopes:g.frozenAmount.redEnvelope,bestRedEnvelope:i.voucherSerialNo||b,show:!0},a.haveRedEnvelope=a.availableRedEnvelopes.length+a.frozenRedEnvelopes.length>0,h.renderRedEnvelope(a),h.unlockSubmitPayment()};if(!$.isEmptyObject(i)||e){if(j<g.totalPayableAmount.balance)a.confirm("<div class='pt45 pb45 tac'>当前支付超出订单总额,继续支付将调整余额支付</div>",{area:"530px",btn:["确定","取消"],title:!1},function(c){$("#balancePaymentInput").val((j/100).toFixed(2)),$(".balance-amount-pay .discount-amount-value").text("-￥"+(j/100).toFixed(2)),g.totalPayableAmount.balance=j,k(b),a.close(c)},function(){$("#redEnvelope .hz-dropdown-content").hide()});else{var l=(f.result||{}).accountRedEnvelopeInfo;g.ableAmount.redEnvelope=l.availableRedEnvelopes||[],g.frozenAmount.redEnvelope=l.frozenRedEnvelopes||[],k(i.voucherSerialNo||b)}$("#redEnvelopePay").siblings(".small-loading").remove()}else{if(b&&!e)return void a.alert2("<div class='pt45 pb45 tac'>该红包暂时不能使用</div>",{area:"530px",title:!1},function(b){$("#redEnvelope .hz-dropdown-content").hide(),a.close(b)});$("#redEnvelope .hz-dropdown-content").hide()}},j=function(b){h.unlockSubmitPayment(),a.msg(b.message||"使用红包失败")};h.checkInputPaymentInfos(i,j)},unFrozenAmount:function(c,d,e){if(void 0!==c){var f={url:"/api/orders/"+c+"/freezed/currency",method:"DELETE"},g=function(b){b.result===!0&&e(),a.msg(b.result===!0?"解冻成功!":"解冻失败!")};b.request.postData(f,g)}},checkInputPaymentInfos:function(a,c,d){var e=f.data,g=d||e.alreadyUsedAmount.redEnvelope.voucherSerialNo,h=$("#balancePay").hasClass("hz-check-item-checked")?Math.round(100*$(".balance-amount-pay .discount-pay-input").val()):0,i=$("#beanPay").hasClass("hz-check-item-checked")?Math.round($(".bean-amount-pay .discount-pay-input").val()):0,j=[];if(!$("#balancePay").hasClass("hz-check-item-checked")||0===h&&1!==+e.pushAmountType||j.push({currencyId:1001,amount:h}),!$("#beanPay").hasClass("hz-check-item-checked")||0===i&&3!==+e.pushAmountType||j.push({currencyId:1003,amount:i}),$("#redEnvelopePay").hasClass("hz-check-item-checked")){var k=g;k?j.push({currencyId:1022,voucherNum:k||null}):j.push({currencyId:1022,voucherNum:null})}var l={url:"/api/orders/payment-combination",data:{insurancePaymentInfos:e.insureNumList,paymentItemInfos:j||[],expressFee:e.isShowShipAddress?e.totalPremium>=3e4?0:e.shipPayAmount:0}};e.orderNum&&(l.data.orderNum=e.orderNum),b.request.postData2(l,a,c)},getBalanceBeanAmount:function(a){var c={url:"/api/orders/available/balance",data:f.data.planIds||[]},d=function(b){f.command.refreshBalancesBeanRedEnvelope(b.result||{}),"function"==typeof d&&a(b.result||{})};b.request.postData2(c,d)},activateRedEnvelope:function(d){var e=$(this),g=f.data,h=f.command,i={url:"/api/users/actived/red-envelope",data:{redEnvelopeNum:d||""}},j=function(b){var f=function(b){h.getBalanceBeanAmount(function(){g.needRedEnvelope=!1;var d,f,i=b.result||{},j=i.bestRedEnvelope||{};$.isEmptyObject(j)?a.alert2("<div class='pt45 pb45 tac'>红包激活成功并保存至您账户</div>",{area:"530px",title:!1},function(b){$("#redEnvelope .hz-dropdown-content").hide(),a.close(b)}):(g.alreadyUsedAmount.redEnvelope.voucherSerialNo=j.voucherSerialNo,g.totalPayableAmount.redEnvelope=f=(c.find(g.ableAmount.redEnvelope,function(a){return a.voucherSerialNo===j.voucherSerialNo})||{}).amount||0,g.alreadyUsedAmount.redEnvelope.discountRedEnvelope=g.ableAmount.tryRedEnvelopeAmount=f||0,h.bindTotalPremium(),d={discountRedEnvelope:f,availableRedEnvelopes:g.ableAmount.redEnvelope,frozenRedEnvelopes:g.frozenAmount.redEnvelope,bestRedEnvelope:j.voucherSerialNo,show:!0},d.haveRedEnvelope=d.availableRedEnvelopes.length+d.frozenRedEnvelopes.length>0,h.renderRedEnvelope(d),$("#redEnvelopePay").hasClass("hz-check-item-checked")||$("#redEnvelopePay").addClass("hz-check-item-checked"),a.msg("红包激活成功!")),e.closest(".layui-layer").find(".voucher-serial-input").val(""),e.closest(".layui-layer").find(".layui-layer-close").trigger("click")})},i=function(){h.unlockSubmitPayment(),a.alert2(b.message||"激活失败，请检查输入")};b.result?(g.needRedEnvelope=!0,h.checkInputPaymentInfos(f,i,d)):a.alert2(b.message||"激活失败")};b.request.postData2(i,j)},lockSubmitPayment:function(a){f.data.submitLocked=!0,f.command.message.show(a||"正在验证","loading")},unlockSubmitPayment:function(){f.data.submitLocked=!1,f.command.message.hide()},submitPayment:function(c){if(!(f.data.submitLocked||f.data.blurInput.length>0)){f.data.submitLocked=!0;var d=f.data,e={url:"/api/orders",data:{insurancePaymentInfos:d.insureNumList,paymentItemInfos:[],totalBuyPrice:d.totalPremium,totalDiscount:d.totalDiscount,totalPayable:d.totalGatewayPay,expressFee:d.isShowShipAddress?d.totalPremium>=3e4?0:d.shipPayAmount:0}},g=function(b){var d=b.result.errors||[],e=(d[0]||{}).errorCode,g=(d[0]||{}).message||"系统错误，无法提交",h=b.result.orderNum;return e?(f.command.handlingExceptions({errorCode:e,errorMsg:g}),void(f.data.submitLocked=!1)):void 0===h?(a.msg("未知异常，创建订单失败"),void(f.data.submitLocked=!1)):0===c?void(window.location.href="/orders/payment-bank?orderNum="+h):1===b.result.paymentType||3===b.result.paymentType?void(window.location.href="/orders/payment-success?orderNum="+b.result.orderNum+"&time="+Date.now()):void(window.location.href="/orders/payment?orderNum="+b.result.orderNum+"&time="+Date.now())},h=function(b){f.data.submitLocked=!1;var c=b.status||"";c=c.toString(),"00001"===c?requirejs(["sign-float"],function(a){new a({returnUrl:location.href,showRegister:!0,callback:function(a){location.reload()}});setTimeout(function(){$(".placeholder-text").css("top","0px")},500)}):"10003"===c?a.confirm('<div class="pt45 pb45 tac">'+b.message+"</div>",{btn:["取消","确认"],title:!1,area:"530px"},function(b){a.close(b)},function(b){window.location.href="http://passport.huize.com/SignIn/Quit?returnurl="+window.location.href,a.close(b)}):10102===+c?a.alert2('<div class="pt45 pb45 tac">'+b.message+"</div>",{btn:["知道了"],title:!1,area:"530px"},function(b){a.close(b)}):-2147483648===+c?a.alert2(b.message,{btn:["知道了"]},function(){window.location.href="/shopping-cart"}):b.message&&a.alert2('<div class="pt45 pb45 tac">'+b.message+"</div>",{title:!1,btn:["知道了"],area:"530px"},function(){window.location.href="/shopping-cart"})};if(d.orderNum&&(e.data.orderNum=d.orderNum),d.totalPayableAmount.bean>0&&3!==d.paymentType&&e.data.paymentItemInfos.push({currencyId:1003,amount:d.totalPayableAmount.bean}),d.totalPayableAmount.redEnvelope>0&&3!==d.paymentType&&e.data.paymentItemInfos.push({currencyId:1022,voucherNum:d.alreadyUsedAmount.redEnvelope.voucherSerialNo,amount:d.totalPayableAmount.redEnvelope}),d.totalPayableAmount.balance>0&&3!==d.paymentType&&e.data.paymentItemInfos.push({currencyId:1001,amount:d.totalPayableAmount.balance}),d.totalGatewayPay>0&&3!==d.paymentType&&(e.data.gatewayPaymentItemInfo={amount:d.totalGatewayPay,paymentGatewayId:c}),3===d.paymentType&&(e.data.bankWitholdingPaymentInfo={amount:d.totalPremium},delete e.data.paymentItemInfos),d.isShowShipAddress){var i=!0;for(var j in d.shipAddress)d.shipAddress[j]&&"id"!==j&&(i=!1);if(i)return a.alert2("<div class='pt45 pb45 tac'>请填写寄送地址</div>",{title:!1,area:"530px",btn:["知道了"]},function(b){a.close(b)}),!1;e.data.shipAddress=d.shipAddress}b.request.postData2(e,g,h)}}},initEvent:function(){$(document).delegate(".input-select","click",function(){var a=$(this).find(".input-select-text"),b=$(this).siblings(".hz-dropdown-content"),c=(a[0]||{}).tagName.toLowerCase();b.toggle().delegate(".hz-select-option","click",function(){"input"===c?a.attr("readOnly",!1).val($(this).text()):"span"===c&&a.text($(this).text()),$(this).closest(".hz-dropdown-content").hide(),$(this).unbind("click")})}),$(".send-type-select").click(function(){var a=$(this).siblings(".hz-dropdown-content"),b=f.data;a.find(".hz-select-option").click(function(){for(var a=!1,c=$(this).closest(".hz-dropdown").find(".input-select-text"),d=$(this).closest("tr").data("insurenum"),e=b.insureNumList,g=e.length;g--;)e[g].insuranceNum===d&&(e[g].needPaper=2===+$(this).data("policy-value")||3===+$(this).data("policy-value"));c.data("policy-selected",$(this).data("policy-value")),$(this).closest(".hz-dropdown-content").hide();var h=$("[data-policy-selected]");h.each(function(){return 2===+$(this).data("policy-selected")||3===+$(this).data("policy-selected")?void(a=!0):void 0}),b.isShowShipAddress=a,$("#sendMessage")[a?"show":"hide"](),$("#shipPayment")[a&&b.totalPremium<3e4?"show":"hide"](),f.command.bindTotalPremium(),$(this).unbind("click")})}),$("#editAddress").click(function(){f.command.linkAddress(),setTimeout(function(){$("#mailingAddressDialog").find("input[name='addressee'],input[name='phone']").placeholder({wrapTagName:!1}),$("#mailingAddressDialog").find("textarea[name='fullAddress']").placeholder({wrapTagName:!1}).siblings("span").css("top","-22px"),void 0===f.data.firstEditAddress&&$("#mailingAddressDialog").delegate(".hz-select-option","click",function(){var a=$("#mailingAddressDialog"),b=a.data("errorMessage")||{},c=$(this).closest(".hz-dropdown").find(".input-select-text");if(b[c.attr("name")]&&delete b[c.attr("name")],$.isEmptyObject(b))a.find(".hz-alert-text").text(""),a.find(".hz-alert").hide();else{var d;for(var e in b){d=b[e];break}a.find(".hz-alert-text").text(d)}c.removeClass("input-text-error");var f=$(this).data("item")||{};c.attr("selected-code",f.districtCode||f.cityCode||f.provinceCode||"")}),f.data.firstEditAddress=!1;var a=f.data.shipAddress;""===a.fullAddress?$("#mailingAddressDialog textarea[name='fullAddress']").siblings(".placeholder-text").show():$("#mailingAddressDialog textarea[name='fullAddress']").siblings(".placeholder-text").hide(),""===a.name?$("#mailingAddressDialog input[name='addressee']").siblings(".placeholder-text").show():$("#mailingAddressDialog input[name='addressee']").siblings(".placeholder-text").hide(),""===a.mobileNo?$("#mailingAddressDialog input[name='phone']").siblings(".placeholder-text").show():$("#mailingAddressDialog input[name='phone']").siblings(".placeholder-text").hide()},500),a.open({type:1,title:"寄送地址",area:"400px",shadeClose:!0,content:$(".mailing-address-dialog"),end:function(){var a=$("#mailingAddressDialog");a.data("changeAddress"),a.data("errorMessage");a.data("errorMessage",{}),a.find("input,textarea").removeClass("input-text-error"),$("#mailingAddressDialog .hz-alert-error").hide()}})}),$("#beanPay").click(function(){f.command.toggleSelectPayment.call(this,3)}),$("#redEnvelopePay").click(function(){f.command.toggleSelectPayment.call(this,2)}),$("#balancePay").click(function(){f.command.toggleSelectPayment.call(this,1)}),$(".bean-amount-pay").find(".discount-pay-input").blur(function(){f.data.blurInput=$(this)}).focus(function(){f.command.editAmount.call(this,3),f.data.blurInputOldValue=$(this).val(),"none"!==$("#redEnvelope .hz-dropdown-content").css("display")&&$("#redEnvelope .hz-dropdown-content").hide()}),$(".balance-amount-pay").find(".discount-pay-input").blur(function(){f.data.blurInput=$(this)}).focus(function(){f.command.editAmount.call(this,1),"none"!==$("#redEnvelope .hz-dropdown-content").css("display")&&$("#redEnvelope .hz-dropdown-content").hide()}),$("#mailingAddressDialog").verify({submit:"#saveAddressBtn",errorAction:function(a){var b=a.data("errorMessage"),c=b[$(this).attr("name")];if(void 0!==c)a.find(".hz-alert-text").text(c),$(this).addClass("input-text-error"),a.find(".hz-alert").show();else{if(delete b[$(this).attr("name")],$.isEmptyObject(b))a.find(".hz-alert-text").text(""),a.find(".hz-alert").hide();else{var d;for(var e in b){d=b[e];break}a.find(".hz-alert-text").text(d)}$(this).removeClass("input-text-error")}},onSubmit:function(){var a,c={},d=$(this),e=f.data.shipAddress,g=f.data;if(d.find(".input-select-text").each(function(){a=d.data("errorMessage")||{},$(this).val().indexOf("/")>-1&&"none"!==$(this).closest(".hz-dropdown").css("display")||""===$(this).val()?(void 0!==$(this).attr("name")&&(a[$(this).attr("name")]=$(this).attr("msg")),d.data("errorMessage",a).data("valid",!1)):delete a[$(this).attr("name")]}),d.find("input[type='text'],textarea").each(function(){"none"!==$(this).closest(".hz-dropdown").css("display")&&(c[$(this).attr("name")]=$(this).val());
}),a=d.getError(),$.isEmptyObject(c)||!d.data("valid"))return d.find("input,textarea").each(function(){return void 0!==a[$(this).attr("name")]?(d.find(".hz-alert-text").text(a[$(this).attr("name")]),$(this).addClass("input-text-error"),d.find(".hz-alert").show(),!1):void 0}),!1;$.isEmptyObject(a)&&(d.find(".hz-alert-text").text(""),d.find(".hz-alert").hide(),$("input,textarea").removeClass("input-text-error")),"none"!==$("#provinceSelect .input-select").css("display")&&(e.provinceCode=$("#provinceSelect input").attr("selected-code")),"none"!==$("#citySelect").css("display")?e.cityCode=$("#citySelect input").attr("selected-code"):e.cityCode="","none"!==$("#areaSelect").css("display")?e.districtCode=$("#areaSelect input").attr("selected-code"):e.districtCode="",$("#sendMessage .send-add").text(c.province+(c.city||"")+(c.district||"")+c.fullAddress).show(),$("#sendMessage .send-user").text(c.addressee).show(),$("#sendMessage .send-tel").text(c.phone).show(),f.data.shipAddress.address=c.fullAddress,f.data.shipAddress.name=c.addressee,f.data.shipAddress.mobileNo=c.phone,d.data("changeAddress",!0),$(this).closest(".layui-layer").find(".layui-layer-close").trigger("click"),$("#editAddress").text("修改");var h=g.shipAddress,i={url:"/api/users/addresses/"+g.shipAddress.id,method:"PUT",data:{name:h.name,address:h.address,mobileNo:h.mobileNo,provinceCode:h.provinceCode,cityCode:h.cityCode,districtCode:h.districtCode}},j=function(a){};b.request.postData2(i,j)}}),$("body").click(function(b){var c=b.target,d=f.data.blurInput||[],e=$(c).closest(".pay-amount-dropdown,#redEnvelope"),g=$(c).closest("#beanPay,#redEnvelopePay,#balancePay"),h=$(".confirm-order-operate-list .hz-dropdown-content:visible").closest(".confirm-order-operate-item").find(".hz-check-item"),i=$(c).closest(".confirm-order-operate-item").find(".hz-check-item");(0===e.length&&(0===g.length||!(g.hasClass("hz-check-item-checked")||g.find(".hz-check-item-checked").length>0))||0!==i.length&&0!==h.length&&i[0].id!==h[0].id)&&$(".pay-amount-dropdown .hz-dropdown-content,#redEnvelope .hz-dropdown-content").hide();var j=$(".bd-cate-dropdown .hz-dropdown-content:visible"),k=$(c).closest(".bd-cate-dropdown");if(0===k.length?$(".bd-cate-dropdown .hz-dropdown-content").hide():j.closest("tr").data("insurenum")!==k.closest("tr").data("insurenum")&&$(".bd-cate-dropdown .hz-dropdown-content").hide(),0===$(c).closest("#payTypeSelect").length&&"none"!==$("#payTypeSelect .hz-dropdown-content").css("display")&&$("#payTypeSelect .hz-dropdown-content").hide(),0!==d.length){var l=0!==$(c).closest(".bean-amount-pay,.balance-amount-pay").length&&0!==$(c).closest(".pay-amount-dropdown").length,m=(d[0]||{}).id===c.id,n="submitPayment"===c.id,o=0,p=f.data,q=f.command,r=d.closest(".confirm-order-operate-item").find(".hz-check-item").attr("id"),s=c.id===r||$(c).closest(".hz-check-item").attr("id")===r;if(!l&&!m&&0!==d.length&&!s){if(d.val(d.val().trim()),"beanPaymentInput"!==d[0].id||/^\d+$/.test(d.val())||(a.msg("请输入正整数"),d.val(0)),"balancePaymentInput"===d[0].id){var t=/^\d+(?:\.(\d+))?$/.exec(d.val());null===t?(a.msg("请输入正确的金额"),d.val("0.00")):void 0!==t[1]&&t[0].length>2&&d.val(Number(d.val()).toFixed(2))}o=d.closest(".bean-amount-pay,.balance-amount-pay").hasClass("bean-amount-pay")===!0?3:1;var u=Number(p.blurInput.val());if((1===o?Math.round(100*u):u)>p.ableAmount[1===o?"balance":"bean"]){var v=p.blurInputOldValue;return a.alert2("你输入的"+(1===o?"金额":"金豆数量")+"不能大于当前可用的"+(1===o?"金额":"金豆数量"),{btn:["知道了"],closeBtn:0},function(b){d.val(v),p.totalPayableAmount[1===o?"balance":"bean"]=Math.round(v*(1===o?100:1)),a.close(b)}),void(p.blurInput=[])}n?(a.msg("正在验证支付方式，请稍后提交!"),p.submitLocked=!0):q.lockSubmitPayment(),q.checkBalanceBean.call(d,o,function(){var a=d.val();d.parent().append($("<span class='discount-amount-value'></span>").text("-￥"+(1===o?Number(a):a/100).toFixed(2))),q.bindTotalPremium()})}}}),$(".bean-amount-pay,.balance-amount-pay,.red-envelope-pay").delegate(".un-frozen-account","click",function(){var a=f.data,b=$(this).parent().data("order-num")||"",c=$(this).closest(".bean-amount-pay").length>0?3:$(this).closest(".balance-amount-pay").length>0?1:2,d=$(this).closest(".bean-amount-pay,.balance-amount-pay,.red-envelope-pay"),e=a.alreadyUsedAmount.redEnvelope.voucherSerialNo,g=($(this).parent().data("amount"),d.find(".discount-pay-input"),f.command);g.unFrozenAmount.call(d,b,c,function(b){g.lockSubmitPayment("正在解冻"),g.getBalanceBeanAmount(function(b){g.checkInputPaymentInfos(function(f){var h=(f||{}).result||{};a.ableAmount.redEnvelope=(h.accountRedEnvelopeInfo||{}).availableRedEnvelopes||[],a.frozenAmount.redEnvelope=(h.accountRedEnvelopeInfo||{}).frozenRedEnvelopes||[];var i=b,j=$("#redEnvelopePay").hasClass("hz-check-item-checked");$.each(i.accountBalances||[],function(b,c){1001===c.currencyId?a.currentAbleAmount.balance=$("#balancePaymentInput").val()||a.currentAbleAmount.balance:1003===c.currencyId&&(a.currentAbleAmount.bean=$("#beanPaymentInput").val()||a.currentAbleAmount.bean)}),g.bindRedEnvelope((h.bestRedEnvelope||{}).voucherSerialNo||e,j),g.bindBalanceBeanAmount.call(d,c),g.unlockSubmitPayment()})})})}),$(".red-envelope-pay").delegate(".target-red-button","click",function(){$(".dialog-new-red").find(".voucher-serial-input").val("").removeClass("input-text-error"),$(".dialog-new-red").find(".hz-alert").hide();a.open({type:1,title:"激活新红包",area:"400px",shadeClose:!0,content:$(".dialog-new-red")})}),$("#activateRedEnvelope").click(function(){var a=$(".dialog-new-red").find(".voucher-serial-input"),b=a.val()||"";return""===b?($(".dialog-new-red").find(".hz-alert").addClass("hz-alert-error").show(),void a.addClass("input-text-error")):($(".dialog-new-red").find(".hz-alert").removeClass("hz-alert-error").hide(),a.removeClass("input-text-error"),void f.command.activateRedEnvelope.call(this,b))}),$(".red-envelope-pay").delegate(".use-redEnvelope-btn","click",function(){var a=$(this).parent().data("oucher-num"),b=$(this).parent().data("discount-redenvelope");f.data.alreadyUsedAmount.redEnvelope.voucherSerialNo=a,f.data.ableAmount.tryRedEnvelopeAmount=b,a&&f.command.useRedEnvelope.call($(this),a,b)}),$("#submitPayment").click(function(){var a="转账汇款"===$.trim($("#payTypeSelect .input-select-text:visible").text())?0:99;f.command.submitPayment(a)})}};return f});