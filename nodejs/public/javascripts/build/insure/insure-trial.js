/**
 ** 
 ** www.huize.com; 
 ** Version:0.1.0;
 ** Last Updated:2016-08-09; 
 **
 **/
define(["helper","jquery"],function(a,$){"use strict";var b=function(){};return b.prototype={initTrial:function(){this.setTrialItem();var a=this;a.el.delegate(".insure-form","change",function(){$(this).attr("trial")&&a.trialChange(this),"cName"===$(this).attr("name")&&a.resetRightContent()})},lastGenes:{},setTrialItem:function(a){var b=this,c=a||b.el;$.each(b.ruleParam.genes,function(a,d){if(d.key)switch(d.key){case b.INSURANTDATEKEY:c.find("[data-moduleid="+b.MODULES_ID_INSURED+"][data-attributeid="+b.ATTR_ID_BIRTHDATE+"]").attr("trial",!0),b.el.find("[data-attributeid="+b.ATTR_ID_INSURE_DATE+"]").attr("trial",!0),b.el.find("[data-moduleid="+b.MODULES_ID_INSURE+"][data-attributeid="+b.ATTR_ID_BIRTHDATE+"]").attr("trial",!0);break;case b.INSURANTJOBKEY:c.find("[data-moduleid="+b.MODULES_ID_INSURED+"][data-attributeid="+b.ATTR_ID_JOB+"]").attr("trial",!0),b.el.find("[data-moduleid="+b.MODULES_ID_INSURE+"][data-attributeid="+b.ATTR_ID_JOB+"]").attr("trial",!0);break;case b.SEXKEY:c.find("[data-moduleid="+b.MODULES_ID_INSURED+"][data-attributeid="+b.ATTR_ID_SEX+"]").attr("trial",!0),b.el.find("[data-moduleid="+b.MODULES_ID_INSURE+"][data-attributeid="+b.ATTR_ID_SEX+"]").attr("trial",!0);break;case b.VESTERAGEKEY:c.find("[data-moduleid="+b.MODULES_ID_INSURE+"][data-attributeid="+b.ATTR_ID_BIRTHDATE+"]").attr("trial",!0),b.el.find("[data-attributeid="+b.ATTR_ID_INSURE_DATE+"]").attr("trial",!0);break;case b.VESTERSEX:b.el.find("[data-moduleid="+b.MODULES_ID_INSURE+"][data-attributeid="+b.ATTR_ID_SEX+"]").attr("trial",!0)}}),c.find("[data-moduleid="+b.MODULES_ID_INSURED+"][data-attributeid="+b.ATTR_ID_BUYCOUNT+"]").attr("trial",!0),b.trialChange(),b.isPriceModify=b.insurance.priceModify||!1},isTrialChange:!1,isPriceModify:!1,trialChange:function(a){var b=this,c=$("#module-20").find(".insurant-item-form");if(!a)return void c.each(function(a){var c=$(this),d=b.getGenesString(c);b.postChangeData(d,c)});var d=$(a),e=d.data("attributeid"),f=d.data("moduleid");if(e===b.ATTR_ID_INSURE_DATE||f===b.MODULES_ID_INSURE)return void c.each(function(a){var c=$(this),d=b.getGenesString(c);b.postChangeData(d,c)});var g=d.parents(".insurant-item-form"),h=b.getGenesString(g);b.postChangeData(h,g)},getGenesString:function(a){var b=this,c={value:""},d={planId:b.ruleParam.planId,productId:b.ruleParam.productId,baseProductId:b.ruleParam.baseProductId,basePlanId:b.ruleParam.basePlanId,platform:1,channel:1,genes:[]},e=[];b.ruleParam.optGeneOldValue&&(c.value=b.ruleParam.optGeneOldValue.value,b.ruleParam.optGeneOldValue.key&&(c.key=b.ruleParam.optGeneOldValue.key),b.ruleParam.optGeneOldValue.protectItemId&&(c.protectItemId=b.ruleParam.optGeneOldValue.protectItemId),d.optGeneOldValue=c),$.each(b.ruleParam.genes,function(c,d){var f,g={protectItemId:d.protectItemId||"",key:d.key||"",value:""};if(d.key)switch(d.key){case b.INSURANTDATEKEY:f=a.find("[data-moduleid="+b.MODULES_ID_INSURED+"][data-attributeid="+b.ATTR_ID_BIRTHDATE+"]").val(),b.isSelf&&(f=f||b.el.find("[data-moduleid="+b.MODULES_ID_INSURE+"][data-attributeid="+b.ATTR_ID_BIRTHDATE+"]").val());break;case b.INSURANTJOBKEY:f=a.find("[data-moduleid="+b.MODULES_ID_INSURED+"][data-attributeid="+b.ATTR_ID_JOB+"][job=3]:visible").find(".hz-select-option-selected").attr("level")||a.find("[data-moduleid="+b.MODULES_ID_INSURED+"][data-attributeid="+b.ATTR_ID_JOB+"][job=2]:visible").find(".hz-select-option-selected").attr("level"),b.isSelf&&(f=f||b.el.find("[data-moduleid="+b.MODULES_ID_INSURE+"][data-attributeid="+b.ATTR_ID_JOB+"][job=3]:visible").find(".hz-select-option-selected").attr("level")||b.el.find("[data-moduleid="+b.MODULES_ID_INSURE+"][data-attributeid="+b.ATTR_ID_JOB+"][job=2]:visible").find(".hz-select-option-selected").attr("level"));break;case b.BUYCOUNTKEY:f=a.find("[data-moduleid="+b.MODULES_ID_INSURED+"][data-attributeid="+b.ATTR_ID_BUYCOUNT+"]").val();break;case b.SEXKEY:f=a.find("[data-moduleid="+b.MODULES_ID_INSURED+"][data-attributeid="+b.ATTR_ID_SEX+"].hz-radio-item-checked  .hz-radio-text").html(),b.isSelf&&(f=f||b.el.find("[data-moduleid="+b.MODULES_ID_INSURE+"][data-attributeid="+b.ATTR_ID_SEX+"].hz-radio-item-checked .hz-radio-text").html());break;case b.VESTERAGEKEY:f=b.el.find("[data-moduleid="+b.MODULES_ID_INSURE+"][data-attributeid="+b.ATTR_ID_BIRTHDATE+"]").val();break;case b.VESTERSEX:f=b.el.find("[data-moduleid="+b.MODULES_ID_INSURE+"][data-attributeid="+b.ATTR_ID_SEX+"].hz-radio-item-checked .hz-radio-text").html()}g.value=f||d.value,e.push(g)});var f=b.el.find("[data-attributeid="+b.ATTR_ID_INSURE_DATE+"]").val();if(f&&f.replace(/\s/g,""))try{var g=new Date(f.replace(/\s/g,""));g&&!isNaN(g.getDay())&&(f=b.getCurrentTime(g),d.insureDateTime=f)}catch(h){}return d.genes=e,d=JSON.stringify(d),a.attr("data-genes",d),d},postChangeData:function(a,b){var c=this,d="/api/insurance-slips/restrict-rule";$.post(d,{data:a},function(a){c.info(a),c.resetSinglePrice(a,b),c.lastGenes=a.result})},resetSinglePrice:function(a,b){var c=a.result,d=a.status;if(c.trialPrice&&c.trialPrice.isInsure){var e=0,f=0,g=this,h=b.find("[data-moduleid="+g.MODULES_ID_INSURED+"][data-attributeid="+g.ATTR_ID_BUYCOUNT+"]").val()||1;if(f=c.trialPrice.totalPreminum,e=c.trialPrice.vipPrice,h=c.trialPrice.buyCount,g.isReady){var i=parseInt($(this).attr("data-price")||0);i!==e&&(g.isTrialChange=!0)}b.attr("data-restrictRule",JSON.stringify(c)),b.attr("data-price",e),b.attr("data-originalPrice",f),b.attr("data-buycount",h),b.attr("data-statuCode",d)}else{if(c.restrictResult&&c.restrictResult.status){d=c.restrictResult.status;var j=c.restrictResult.data.total||0;b.attr("data-price",j)}b.attr("data-statuCode",d)}this.resetTotalPrice()},totalPrice:0,resetTotalPrice:function(){var a=this,b=a.el.find("[data-price]:visible"),c=0,d=0,e=!1,f=!1;b.each(function(b){var g=$(this).attr("data-price")||0,h=$(this).attr("data-originalPrice")||0,i=$(this).attr("data-statuCode")||"";c+=parseInt(g,10),d+=parseInt(h,10),h/100>=a.HEIGHTPRICE&&"36058"!==i&&(e=!0),"36058"===i&&(f=!0)}),a.insurance.restrictRule.trialPrice.insurantPayment||(c=parseInt(b.eq(0).attr("data-price")||0),d=parseInt(b.eq(0).attr("data-originalPrice")||0)),e?a.showUploadImg(!0):a.showUploadImg(!1),f&&a.showHighPremiumOver(),a.totalPrice=c,a.resetRightContent()},resetRightContent:function(){var a=this,b=[],c=[],d=0,e=0,f=a.insurance.vipPrice===a.totalPrice&&a.insurance.payAmount&&a.insurance.payAmount!==a.insurance.vipPrice,g=a.el.find("[data-price]:visible");if(a.isMoreInsurant||a.isTeamInsurant){if(a.isMoreInsurant){var h=0;c.push('<ul class="hz-list lh20">'),g.each(function(b){var d=$(this).attr("data-price")||0,e=$(this).attr("data-buycount")||1,g=$(this).find('[name="cName"]'),i=$(g).val();if(d=(d/100).toFixed(2),d=f?"-  -":"¥"+d,!a.insurance.restrictRule.trialPrice.insurantPayment&&h>=1&&(d="¥0.00"),i){var j=[],k="";h>=5&&(k="collapse-item fn-hide"),h++,j.push('<h4 class="fc6 f14 fb mb5">投保份数</h4><p class="f12 fc6 mb15">'+e+" 份</p>"),j.push(a.renderProtectItme()),c.push(' <li class="hz-list-item '+k+'" rel="prompt" data-prompt-html=\''+j.join("")+'\' data-prompt-position="left">'),c.push(' <div class="hz-list-title"><span class="list-sub-title inline-block ell">'+i+"</span></div>"),c.push(' <p class="hz-list-content tar">'+d+"</p>"),c.push("</li>")}}),c.push("</ul>"),h>5&&(c.push('<p class="tac mt15 f12 fc6 show-more"><a href="javascript:;">显示全部<i class="iconfont">&#xe70b;</i></a></p>'),c.push('<p class="tac mt15 f12 fc6 collapse-more fn-hide"><a href="javascript:;">收起<i class="iconfont">&#xe708;</i></a></p>')),c.push('<div class="hz-list lh20">'),c.push('<div class="hz-list-item">'),c.push('<div class="hz-list-title">人数</div>'),c.push('<p class="hz-list-content tar">'+g.length+"</p>"),c.push("</div>"),c.push("</div>")}else if(a.isTeamInsurant){var i=a.teamNum,e=a.trialPrice.singlePrice||0,j=a.trialPrice.vipPrice||0,k=(a.trialPrice.originalPrice||0,a.trialPrice.buyCount||1),l=j*i;e=(e/100).toFixed(2),c.push('<div class="hz-list lh20">'),c.push('<div class="hz-list-item">'),c.push('<span class="hz-list-title">价格</span>'),c.push('<p class="hz-list-content tar">¥'+e+"</p>"),c.push("</div>"),c.push('<div class="hz-list-item">'),c.push('<span class="hz-list-title">人数</span>'),c.push('<p class="hz-list-content tar">'+i+"</p>"),c.push("</div>"),c.push('<div class="hz-list-item">'),c.push('<span class="hz-list-title">份数</span>'),c.push('<p class="hz-list-content tar">每人'+k+" 份</p>"),c.push("</div>"),c.push("</div>"),b.push(a.renderProtectItme()),a.totalPrice=l,a.trialPrice.originalPrice/100>=a.HEIGHTPRICE?a.showUploadImg(!0):a.showUploadImg(!1)}}else{var m=g[0],n=$(m).attr("data-price")||0,o=$(m).attr("data-buycount")||1;f&&(n=a.insurance.payAmount),e=n/o,e=(e/100).toFixed(2),n=(n/100).toFixed(2),c.push('<div class="hz-list lh20">'),c.push('<div class="hz-list-item">'),c.push('<span class="hz-list-title">价格</span>'),c.push('<p class="hz-list-content tar">¥'+e+"</p>"),c.push("</div>"),c.push('<div class="hz-list-item">'),c.push('<span class="hz-list-title">份数</span>'),c.push('<p class="hz-list-content tar">'+o+" 份</p>"),c.push("</div>"),c.push("</div>"),b.push(a.renderProtectItme())}$("#rightBody").html(b.join("")),$("#rightFoot").html(c.join("")),f&&(a.totalPrice=a.insurance.payAmount),d=(a.totalPrice/100).toFixed(2),$(".secondary-hot-product .secondary-hot-product-foot .primary-color span").html(d),$('[rel="prompt"]').prompt(),$("#rightFoot").delegate(".show-more","click",function(){$(this).prevAll(".hz-list").find(".fn-hide").removeClass("fn-hide"),$(this).addClass("fn-hide"),$(this).siblings(".collapse-more").removeClass("fn-hide")}).delegate(".collapse-more","click",function(){$(this).prevAll(".hz-list").find(".collapse-item").addClass("fn-hide"),$(this).addClass("fn-hide"),$(this).siblings(".show-more").removeClass("fn-hide")})},getLastGenesString:function(){return this.lastGenes},renderProtectItme:function(){var b=this,c=[],d=a.utils.marginProtectList(b.protectItmes);return c.push('<h4 class="fc6 f14 fb mb5">保障权益</h4>'),d.length>6?c.push('<div class="protect-list-box" style="overflow: hidden;overflow-y: auto;height: 166px;"><ul class="hz-list f12 fc6 lh20">'):c.push('<div class="protect-list-box"><ul class="hz-list f12 fc6 lh20">'),d.forEach(function(a,d){var e=a.fullPremium,f=a.relateCoverageId;if(!e){var g=b.insurance.genes;g.forEach(function(a,b){a.protectItemId&&a.protectItemId===parseInt(f)&&(e=a.value)})}e&&(a.showUnit&&(e+=a.showUnit),c.push('<li class="hz-list-item">'),c.push('<span class="hz-list-title ell">'+a.name+"</span>"),c.push('<p class="hz-list-content ell"><span class="pl10">'+e+"</span></p>"),c.push("</li>"))}),c.push("</ul></div>"),c.join("")},defaultGenesRestrict:[],getGenesRestrict:function(a){var b=this;if(b.defaultGenesRestrict&&b.defaultGenesRestrict.length>0)a();else{var c="/api/products/"+b.ruleParam.productId+"/restrict-rule",d={planId:b.ruleParam.planId,productId:b.ruleParam.productId,baseProductId:b.ruleParam.baseProductId,basePlanId:b.ruleParam.basePlanId,platform:1,channel:1,genes:[]},e=[];$.each(b.ruleParam.genes,function(a,b){var c={protectItemId:b.protectItemId||"",key:b.key||"",value:b.value};e.push(c)}),d.genes=e,d=JSON.stringify(d),$.post(c,{data:d},function(c){var d=c.result.restrictGenes;b.info("获取详情页试算的约束"),b.info(d),b.defaultGenesRestrict=d,a()})}},runGenesRestrict:function(a){var b=this,c=a||b.el;b.isTeamInsurant||b.getGenesRestrict(function(){var a=b.defaultGenesRestrict;$.each(a,function(a,d){if(d.key&&"sex"===d.key){var e=d.dictionaryList||[],f=c.find("[data-moduleid="+b.MODULES_ID_INSURED+"][data-attributeid="+b.ATTR_ID_SEX+"]");$.each(f,function(){var a=$(this).find(".hz-radio-text").html(),b=!1;$.each(e,function(){this.value.indexOf(a)>-1&&(b=!0)}),b||$(this).remove()})}else if(d.key&&"buyCount"===d.key){var e=d.dictionaryList||[],g=d.dictionaryList[0].max,h=d.dictionaryList[0].min;$.each(e,function(){g=this.max>g?this.max:g,h=this.min<h?this.min:h}),b.buyCountRange.max=b.buyCountRange.max<g?b.buyCountRange.max:g,b.buyCountRange.min=b.buyCountRange.min>h?b.buyCountRange.min:h}})})}},b});