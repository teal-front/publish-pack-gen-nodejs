/**
 ** 
 ** www.huize.com; 
 ** Version:0.1.0;
 ** Last Updated:2016-08-09; 
 **
 **/
define(function(){"use strict";var a=function(){};return a.prototype={initBeneficiary:function(){},initBeneficiaryType:function(a){var b=this,c=a?$(a):b.el.find(".insurant-item-form");c.each(function(){var a=$(this).find(".hz-dropdown.beneficiarytype-select");2===b.product.beneficiaryType?b.dropdownSelectItem(a,2):b.dropdownSelectItem(a,1)})},validateBeneficiary:function(){var a=this,b=!0,c=$("#module-20  .zd-beneficiary:visible");return c.each(function(){var c=$(this),d=[],e=[],f=c.parents(".insurant-item-form").find("[data-moduleid="+a.MODULES_ID_INSURED+"][data-attributeid="+a.ATTR_ID_NAME+"]").val(),g=c.find(".beneficiaryFirst .beneficiary-item [data-attributeid=128]"),h=c.find(".beneficiarySecond .beneficiary-item [data-attributeid=128]");if(a.isSelf&&(f=$("[data-moduleid="+a.MODULES_ID_INSURE+"][data-attributeid="+a.ATTR_ID_NAME+"]").val()),c.find(".beneficiaryFirst .beneficiary-item").length>0?(g.each(function(c,e){var g=parseFloat($(e).data("value"));g?d.push(g):(a.saveShopCar||a.layer({content:f+"的"+a.TEXT_BENEFICIARY_ONE}),b=!1)}),100!==a.sum(d)&&(a.saveShopCar||a.layer({content:f+"的"+a.TEXT_BENEFICIARY_ONE}),b=!1)):(a.saveShopCar||a.layer({content:f+"的至少需要填写一位第一顺序受益人"}),b=!1),h.length&&(h.each(function(c,d){var g=parseFloat($(d).data("value"));g?e.push(g):(a.saveShopCar||a.layer({content:f+"的"+a.TEXT_BENEFICIARY_TWO}),b=!1)}),100!==a.sum(e)&&(a.saveShopCar||a.layer({content:f+"的"+a.TEXT_BENEFICIARY_TWO}),b=!1)),!b)return b;var i=c.find(".beneficiary-item"),j=[],k=[];i.each(function(){var b=$(this).find("[data-attributeid="+a.ATTR_ID_CREDENTIALSTYPE+"]").data("value"),c=$(this).find("[data-attributeid="+a.ATTR_ID_CREDENTIALSINPUT+"]").data("value"),d={};d.type=b?b.toString():"",d.value=c?c.toString():"",b&&c&&(k.push(d),j.push($(this)))});for(var l=0;l<k.length;l++)for(var m=l+1;m<k.length;m++)k[l].type===k[m].type&&k[l].value.toUpperCase()===k[m].value.toUpperCase()&&(a.layer({content:f+"的受益人的证件信息出现重复，请重新确认信息"}),b=!1)}),b},renderBeneficiary:function(a,b){var c=this,d=[];return c.addIndex++,c.formIndex++,d.push('<li class="list-table-row list-table-row-editing beneficiary-sub-box  credentials-form" data-index="'+c.formIndex+'">'),d.push('<span class="del-beneficiary del base-btn" data-type="beneficiary"><i class="delete"></i><em>删除</em></span>'),d.push(c.renderTable(a)),d.push('<div class="cell">'),d.push('<div class="cell-inner">'),d.push('<div class="hz-check-item inline-block">'),d.push('<input class="insure-checkbox fl" type="checkbox" name="chkSaveInsure" id="chkSaveInsure-'+a.id+c.formIndex+'"   data-moduleid="'+a.id+'" class="insure-label" value="1" checked />'),d.push('<span class="hz-check-text f12 fc6">保存为常用联系人</span><span class="fl f12 fc6 ml5">'),d.push("</div>"),d.push("</div>"),d.push("</div>"),d.push('<input type="hidden" name="serial" value="'+b+'" />'),d.push("</li>"),d.join("")},addBenficiary:function(a){var b=this,c=$(a).data("type"),d=b.product.firstBeneficiaryLimit,e=b.product.secondBeneficiaryLimit,f=$(a).parents("[data-insurantindex]"),g=$(f).data("insurantindex");"first"===c?$("[data-insurantindex="+g+"]:visible .beneficiaryFirst").find(".beneficiary-sub-box").length<d?b.addFirst(g):b.layer({content:"第一顺序受益人最大数为"+d+"人",btn:!1}):$("[data-insurantindex="+g+"] .beneficiarySecond").find(".beneficiary-sub-box").length<e?b.addsecond(g):b.layer({content:"第二顺序受益人最大数为"+e+"人",btn:!1})},addFirst:function(a){var b=this,c=$("[data-insurantindex="+a+"] .beneficiaryFirst .beneficiary-content");c.find(".credentials-form").length;b.showEditContent(a,1)},showBeneficiarySecond:function(a){var b=$("[data-insurantindex="+a+"] .beneficiarySecond");b.find(".beneficiary-sub-box").length?b.find(".beneficiary-head").show():b.find(".beneficiary-head").hide(),this.resetBeneficiaryNum(b)},addsecond:function(a){var b=this,c=$("[data-insurantindex="+a+"] .beneficiarySecond .beneficiary-content");c.find(".credentials-form").length;b.showEditContent(a,2),b.showBeneficiarySecond(a)},delBeneficiary:function(a){var b=$(a).parents("[data-insurantindex]"),c=$(b).data("insurantindex");$(a).parents(".beneficiary-sub-box").remove(),this.setFirstStatus(c)},editBeneficiary:function(a){var b=this,c=$(a).parents(".beneficiary-sub-box"),d=$(c).data("insurantindex"),e=$(c).data("beneficiaryindex"),f=$(c).data("fromindex");b.showEditContent(d,e,f)},setFirstStatus:function(a){var b=this;b.setDeleteStatus($("[data-insurantindex="+a+"] .beneficiaryFirst"),b.TEXT_DELETED_TYPE_BENEFICIARY),b.showBeneficiarySecond(a),b.resetBeneficiaryNum($("[data-insurantindex="+a+"] .beneficiaryFirst"))},showEditContent:function(a,b,c){var d=this,e=c?"编辑受益人":"添加受益人";d.layer({area:"400px",content:d.beneficiaryDialogHtml.join(""),btn:!1,title:e,shadeClose:!1});var f;$("#beneficiary-dialog").parent().on("scroll",function(){var a=this;clearTimeout(f),f=setTimeout(function(){MyCalendar.closeAll(),$(a).find("input").blur()},100)});var g=$("#beneficiary-dialog");d.initCalendar(g),d.eventCheckbox(g),d.eventRadio(g),d.eventDrowDown(g),d.defaultRestrict(g),g.delegate(".insure-form","change",function(){($(this).hasClass("credentials")||$(this).hasClass("id-card-input"))&&d.autoSetIdInfo(this)}),$("#beneficiarySave").attr("data-insurantindex",a),$("#beneficiarySave").attr("data-beneficiaryindex",b),c&&($("#beneficiarySave").attr("data-fromindex",c),d.fillEditContent(a,b,c)),d.bindContacts(d,g,g),d.defaultSelectIdCard(g),g.delegate(".beneficiary-save","click",function(){d.beneficiarySaveClick()}).delegate(".form-item","blur",function(){if(d.validate(this)){if($(this).hasClass("proportion")&&parseFloat($(this).val())<=0)return void d.beneficiaryValidateError(this,"受益比例应大于0");d.beneficiaryValidateSuccess(this)}else d.beneficiaryValidateError(this)}),$("#beneficiary-dialog").find("input:visible").placeholder({})},beneficiarySaveClick:function(){var a=this,b=!0;b=a.validateSingleBeneficiary(),b&&(a.saveBeneficiaryContent(),layer.closeAll())},saveBeneficiaryContent:function(){var a=this,b=[],c=$("#beneficiary-dialog").find(".form-item:not(.hz-radio-item)"),d=$("#beneficiary-dialog").find(".form-item.hz-radio-item.hz-radio-item-checked"),e=$("#beneficiarySave").data("insurantindex"),f=$("#beneficiarySave").data("beneficiaryindex"),g=$("#beneficiarySave").data("fromindex"),h=!0;g||(h=!1,a.formIndex++,g=g?g:a.formIndex);var i='data-insurantindex="'+e+'" data-beneficiaryindex="'+f+'" data-fromindex="'+g+'"';if(b.push('<tr class="beneficiary-item  beneficiary-sub-box" '+i+">"),b.push('<td class="tac current-index">1</td>'),b.push('<td><ul class="info-list clearfix lh24">'),c.each(function(){var c=$(this),d=c.attr("name"),e=c.data("moduleid"),f=c.data("attributeid"),g=c.data("name"),h=c.val(),i=c.val();if(f===a.ATTR_ID_BENEFICIARY){try{h=parseFloat(h).toFixed(2),i=h}catch(j){}i+="%"}c.hasClass("hz-dropdown")&&(i=c.find(".hz-select-option-selected").text()),"checkbox"===c.attr("type")&&(i="checked"===c.attr("checked")?"是":"否",h="checked"===c.attr("checked"));var k='data-moduleid="'+e+'" data-attributeid="'+f+'" name="'+d+'" data-value="'+h+'"  value="'+h+'"';if(f===a.ATTR_ID_CREDENTIALSTYPE)b.push('<li class="fl">'),b.push('<span class="fc9">'+g+'：</span><span class="insure-form" data-moduleid="30" data-attributeid="3" name="'+d+'" data-value="'+i+'" value="'+i+'">'+i+"</span>"),b.push('<span class="insure-form" data-moduleid="30" data-attributeid="3" name="cardTypeId" data-value="'+h+'" value="'+h+'"></span>'),b.push("</li>");else if(f===a.ATTR_ID_CREDENTIALSVALIDITY){if("cardPeriod"===d){var l=$("#beneficiary-dialog").find("[name=validityTime]").parents(".hz-check-item").hasClass("hz-check-item-checked"),m=$("#beneficiary-dialog").find("[name=cardPeriodEnd]").val();l||(h=h+"|"+m),k='data-moduleid="'+e+'" data-attributeid="'+f+'" name="'+d+'" data-value="'+h+'"  value="'+h+'"',b.push('<li class="fl">'),b.push('<span class="fc9">'+g+'：</span><span class="insure-form" '+k+">"+h+"</span>"),b.push("</li>")}}else{if(b.push('<li class="fl">'),b.push('<span class="fc9">'+g+'：</span><span class="insure-form" '+k+">"+i+"</span>"),c.hasClass("hz-dropdown")){var n='data-moduleid="'+e+'" data-attributeid="'+f+'" name="'+d+'Text" data-value="'+i+'"  value="'+i+'"';b.push('<span class="insure-form" '+n+"></span>")}b.push("</li>")}}),d.each(function(){var a=$(this),c=a.attr("name"),d=a.data("moduleid"),e=a.data("attributeid"),f=a.data("name"),g=a.val()||a.attr("value"),h=a.find(".hz-radio-text").text(),i='data-moduleid="'+d+'" data-attributeid="'+e+'" name="'+c+'"data-value="'+g+'"  value="'+g+'"';b.push('<li class="fl"><span class="fc9">'+f+'：</span><span class="insure-form" '+i+">"+h+"</span></li>")}),b.push("</ul></td>"),b.push('  <td class="tac"><a href="javascript:;" class="primary-link f12 edit" data-type="beneficiary">编辑</a><a href="javascript:;" class="primary-link f12 del" data-type="beneficiary">删除</a></td>'),b.push("</tr>"),h){var j=$("#module-20 .zd-beneficiary[data-insurantindex="+e+"] table").find("tr[data-fromindex="+g+"]");j.replaceWith(b.join(""))}else{var k;k=1==f?$("#module-20 .zd-beneficiary #beneficiaryFirst-"+e).find(".beneficiary-addtr"):$("#module-20 .zd-beneficiary #beneficiarySecond-"+e).find(".beneficiary-addtr"),k.before(b.join(""))}return a.setFirstStatus(e),!0},refillBeneficiaryInfo:function(a,b){var c=this,d=[],e=$("[data-index="+a+"]  [data-insurantindex]").data("insurantindex"),f=b.serial,g=c.beneficiaryItem,h=g.productAttrs||[];c.formIndex++;var i='data-insurantindex="'+e+'" data-beneficiaryindex="'+f+'" data-fromindex="'+c.formIndex+'"';d.push('<tr class="beneficiary-item  beneficiary-sub-box" '+i+">"),d.push('<td class="tac current-index">1</td>'),d.push('<td><ul class="info-list clearfix lh24">'),h.forEach(function(a,e){var f=a.attribute||{},h=f.keyCode,i=g.id,j=f.id,k=f.name,l=f.values||[],m=b[h],n=b[h];n=j===c.ATTR_ID_BENEFICIARY?n+"%":n,0!==f.type&&9!==f.type||l.forEach(function(a,b){a.controlValue===m&&(n=a.value)});var o='data-moduleid="'+i+'" data-attributeid="'+j+'" name="'+h+'"data-value="'+m+'"  value="'+m+'"';if(null!==m&&""!==m&&void 0!==m)if(j===c.ATTR_ID_CREDENTIALSTYPE)m=b.cardTypeId,d.push('<li class="fl">'),d.push('<span class="fc9">'+k+'：</span><span class="insure-form" data-moduleid="30" data-attributeid="3" name="'+h+'" data-value="'+n+'" value="'+n+'">'+n+"</span>"),d.push('<span class="insure-form" data-moduleid="30" data-attributeid="3" name="cardTypeId" data-value="'+m+'" value="'+m+'"></span>'),d.push("</li>");else{if(d.push('<li class="fl">'),d.push('<span class="fc9">'+k+'：</span><span class="insure-form" '+o+">"+n+"</span>"),0===f.type){var p='data-moduleid="'+i+'" data-attributeid="'+j+'" name="'+h+'Text" data-value="'+n+'"  value="'+n+'"';d.push('<span class="insure-form" '+p+"></span>")}d.push("</li>")}});var j=b.chkSaveInsure||!1,k=j?"是":"否";d.push('<li class="fl"><span class="fc9">保存为常用联系人：</span><span class="insure-form" data-moduleid="30" data-attributeid="" name="chkSaveInsure" data-value="'+j+'" value="'+j+'">'+k+"</span></li>"),d.push("</ul></td>"),d.push('  <td class="tac"><a href="javascript:;" class="primary-link f12 edit" data-type="beneficiary">编辑</a><a href="javascript:;" class="primary-link f12 del" data-type="beneficiary">删除</a></td>'),d.push("</tr>");var l;return l=1==f?$("#module-20 .zd-beneficiary #beneficiaryFirst-"+e).find(".beneficiary-addtr"):$("#module-20 .zd-beneficiary #beneficiarySecond-"+e).find(".beneficiary-addtr"),l.before(d.join("")),c.setFirstStatus(e),!0},resetBeneficiaryNum:function(a){var b=$(a),c=b.find(".beneficiary-sub-box").length,d=1;b.find(".beneficiary-count").html(c),b.find(".current-index").each(function(){$(this).html(d),d++})},validateSingleBeneficiary:function(){var a=this,b=$("#beneficiary-dialog").find(".form-item:visible"),c=!0;return b.each(function(){var b=a.validate(this);b?(c=c,a.beneficiaryValidateSuccess(this)):(c=!1,a.beneficiaryValidateError(this))}),c},beneficiaryValidateSuccess:function(a){var b=$(a),c=$("#beneficiaryTips");b.hasClass("hz-dropdown")?b.find(".input-text").removeClass("input-text-error"):b.removeClass("input-text-error"),c.html("")},beneficiaryValidateError:function(a,b){var c=$(a),d=$("#beneficiaryTips"),e=b||c.data("errorremind")||"";c.hasClass("hz-dropdown")?c.find(".input-text").addClass("input-text-error"):c.addClass("input-text-error"),d.html(e)},fillEditContent:function(a,b,c){var d=this,e=$("#beneficiary-dialog"),f=$("[data-insurantindex="+a+"][data-beneficiaryindex="+b+"][data-fromindex="+c+"]").find(".insure-form");return f.each(function(){var a=$(this),b=a.data("value"),c=a.data("attributeid"),f=e.find("[data-attributeid="+c+"]");if(f.length>1)if(c===d.ATTR_ID_CREDENTIALSVALIDITY){var g=b.split("|");g.length>1?(e.find("[name=cardPeriod]").val(g[0]),e.find("[name=cardPeriodEnd]").val(g[1])):(e.find("[name=cardPeriod]").val(g[0]),e.find("[name=validityTime]").parents(".hz-check-item").click())}else f.each(function(){$(this).hasClass("hz-radio-item")&&$(this).attr("value")==b&&$(this).click()});else"checkbox"===f.attr("type")?b===!0?(f.parents(".hz-check-item").addClass("hz-check-item-checked"),f.attr("checked",!0)):(f.parents(".hz-check-item").removeClass("hz-check-item-checked"),f.attr("checked",!1)):f.hasClass("hz-dropdown")?d.dropdownSelectItem(f,b):f.val(b)}),!0},beneficiaryItem:""},a});