/**
 ** 
 ** www.huize.com; 
 ** Version:0.1.0;
 ** Last Updated:2016-08-09; 
 **
 **/
define(["jquery","my-calendar"],function($,a){"use strict";var b=function(){};return b.prototype={startDate:{maxDate:"",minDate:""},insureDate:{maxDate:"",minDate:""},insuredDate:{maxDate:"",minDate:""},date:{maxDate:"",minDate:""},initDate:function(){this.setDateValue(),this.setInsureDate(),this.eventCalendar()},eventCalendar:function(){var a=this;this.el.on("blur",".insure-calendar",function(){var b=a.toInt($(this).data("moduleid")),c=a.toInt($(this).data("attributeid"));c===a.ATTR_ID_BIRTHDATE&&a.MODULES_ID_INSURED===b&&a.setJuvenilesJob(this)}),this.el.delegate(".credentials-validity","change",function(){a.credentialsValidity(this)}),a.initCalendar()},__initCalendarLock:!0,calendarBox:{},calendarIndex:0,initCalendar:function(b,c){var d=this,e=b?$(b):d.el;e.find(".Wdate").not(".bind").each(function(){var b=d.toInt($(this).data("moduleid")),e=d.toInt($(this).data("attributeid"));if($(this).addClass("bind"),!$(this).data("lock")){$(this).data("lock",!0);var f=d.getDefaultStartMinDate(b,e);d.calendarIndex++,d.calendarBox[d.calendarIndex]=new a({el:this,parent:c,zIndex:9999999999,top:function(){var a=0,b=$("body").scrollTop()||$("html").scrollTop()||0,c="team"===$(this.el).data("calendartype"),e="beneficiary"===$(this.el).data("calendartype");return c&&(a=-d.teamBody.scrollTop()-2),e&&(a=b-$("#beneficiary-dialog").parent().scrollTop()),a},defaultValue:f,maxDate:function(){var a=d.getCurrentTime();return b===d.MODULES_ID_INSURE&&e===d.ATTR_ID_BIRTHDATE?(a=d.insureDate.maxDate,d.isSelf&&(a=d.dateDifference(d.insureDate.maxDate,d.insuredDate.maxDate)>=0?d.insureDate.maxDate:d.insuredDate.maxDate)):b===d.MODULES_ID_INSURED&&e===d.ATTR_ID_BIRTHDATE?a=d.insuredDate.maxDate:d.MODULES_ID_INSURE_DATE===b&&d.ATTR_ID_INSURE_DATE===e?a=d.startDate.maxDate:d.ATTR_ID_CREDENTIALSVALIDITY===e&&(a=$(this.el).attr("maxDate")),a},minDate:function(){var a="1900-1-1";return b===d.MODULES_ID_INSURE&&e===d.ATTR_ID_BIRTHDATE?(a=d.insureDate.minDate,d.isSelf&&(a=d.dateDifference(d.insureDate.minDate,d.insuredDate.minDate)>=0?d.insuredDate.minDate:d.insureDate.minDate)):b===d.MODULES_ID_INSURED&&e===d.ATTR_ID_BIRTHDATE?a=d.insuredDate.minDate:d.MODULES_ID_INSURE_DATE===b&&d.ATTR_ID_INSURE_DATE===e?a=d.startDate.minDate:d.ATTR_ID_CREDENTIALSVALIDITY===e&&(a=$(this.el).attr("minDate")),a},callback:function(a,c){var f,g=a||"";$(this.el).blur(),d.insuredAgeCalculation&&d.MODULES_ID_INSURE_DATE===b&&d.ATTR_ID_INSURE_DATE===e&&(d.setInsuredDate({newDate:g}),d.setInsureDate({newDate:g}),d.validateInsureDate()),d.MODULES_ID_INSURE_DATE===b&&d.ATTR_ID_INSURE_DATE===e&&d.showInsurantDateLimit(this.el),"team"===$(this.el).data("type")&&(f=$(this.el).parents(".list-table-row"),d.validateTeamItem(f),d.updateTemaValue(f)),d.trialChange(this.el)}})}})},validateInsureDate:function(a){var b=this,c=!0;if(a){var d=$(a).val(),e=b.dateDifference(b.insuredDate.minDate,d)>=0&&b.dateDifference(d,b.insuredDate.maxDate)>=0;!e&&d&&(c=e,b.hideSuccess(a),b.showError(a,b.TEXT_INSURE_DATA_ERROR))}else b.insuredModules.find(".insurant-item-form:visible").find('.insure-calendar[data-attributeid="'+b.ATTR_ID_BIRTHDATE+'"]').each(function(){var a=$(this).val(),d=b.dateDifference(b.insuredDate.minDate,a)>=0&&b.dateDifference(a,b.insuredDate.maxDate)>=0;!d&&a&&(c=d,b.hideSuccess(this),b.showError(this,b.TEXT_INSURE_DATA_ERROR))});return c},validateInsureAge:function(a){var b=this,c=!0,d=$("#module-10").find('.insure-calendar[name*="birthdate"]'),e=d.val(),f=b.getFullAge({nowDate:b.getStartDateValue(),select:e});if(18>f)b.showError(d[0],b.TEXT_INSURE_MIN_AGE),c=!1,b.submitStatus=!1,a&&b.scrollTo(d);else{var g=b.dateDifference(b.insuredDate.minDate,e)>=0&&b.dateDifference(e,b.insuredDate.maxDate)>=0;!g&&e&&b.isSelf&&(c=g,b.hideSuccess(d[0]),b.showError(d[0],b.TEXT_INSURE_DATA_ERROR))}return c},getStartDateValue:function(){var a="",b=$.trim($("#module-first [data-moduleid=102]").val())||"";return 1===this.insuredAgeCalculation&&b&&(a=b),a},setDateValue:function(){var a=this,b=this.insurance.restrictRule||{},c=b.restrictGenes||[];a.insurantDate="",a.insurantDateLimit="",a.dateDefaultValue="";var d=[];c.forEach(function(b,c){"insurantDate"===b.key&&(a.insurantDate=b.defaultValue,d=b.dictionaryList||[],a.dateDefaultValue=b.defaultValue,a.dateRange=b.rangeDic||""),"insurantDateLimit"===b.key&&(a.insurantDateLimit=b.defaultValue||"")}),a.dateDictionaryList=d,a.info("连续的时间段范围",a.dateRange),a.info("",c),a.setInsureStartDate(),a.setInsuredDate({dictionaryList:d}),a.logRed("默认日期："+a.insurantDate)},setInsureDate:function(a){this.insureDate.maxDate=this.createDate({year:-18}),this.insureDate.minDate=this.createDate({year:-120})},setInsuredDate:function(a){var b=this,c=a||{},d=0,e=b.insureIncludeBirthday,f=c.newDate||b.startDate.minDate,g=b.getDates(f);b.isNumber(g)&&2!==b.product.insuredAgeCalculation||(g=0),b.insuredDate.maxDate=this.createDate({year:0,date:g}),b.insuredDate.minDate=this.createDate({year:-120,date:g});var h=!0;b.logGreen("选中日期："+b.dateDefaultValue),b.dateRange&&!b.isTeamInsurant?!function(){var a,c,d,e=0,f=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=b.dateRange.unit,t=b.dateRange.subrestrict;7===s||8===s||13===s||0===s?(e=b.dateRange.max,i=b.dateRange.min,l=1):9===s?(f=b.dateRange.max,j=b.dateRange.min):10===s&&(h=b.dateRange.max,k=b.dateRange.min),t&&(d=t.unit,7===d||8===d||13===d?(t.min&&(m=t.min),t.max&&(p=t.max)):9===d?(t.min&&(n=t.min),t.max&&(q=t.max)):10===d&&(t.min&&(o=t.min),t.max&&(r=t.max))),a=b.createDate({year:-e-l+m,month:-f+n,date:-h+o+g}),c=b.createDate({year:-i+p,month:-j+q,date:-k+r+g}),b.insuredDate.maxDate=c,b.insuredDate.minDate=a}():b.dateDictionaryList.forEach(function(a,f){if(h){b.insuredDate={maxDate:"",minDate:""},a.value&&a.value+b.getUnit(a.unit)===b.dateDefaultValue&&(h=!1),b.info("日期范围",a,a.value,a.value+b.getUnit(a.unit),b.dateDefaultValue);var i=a.max||0,j=a.min||0,k=a.unit||0,l=a.subrestrict||{},m=(c.newDate||null,""),n="",o=0,p=new Date,q=(new Date,new Date,p.getFullYear(),p.getDate(),0),r=0,s=0,t=0;if("岁"!==b.getUnit(k)&&"周岁"!==b.getUnit(k)&&0!==k||(q=j,r=i,o=1),m=i+b.getUnit(k),n=j+b.getUnit(k),b.isValidDate(b.dateDefaultValue)||(e=0),l&&"天"===b.getUnit(l.unit)){var u=l.max,v=l.min;u&&(s=u),v&&(t=v)}var w=b.createDate({newDate:b.getCurrentTime(),year:-q,date:s+e+g}),x=b.createDate({newDate:b.getCurrentTime(),year:-r-o,date:t+e+g+d});w=b.insuredDate.maxDate&&new Date(b.insuredDate.maxDate)>=new Date(w)?b.insuredDate.maxDate:w,x=b.insuredDate.minDate&&new Date(b.insuredDate.minDate)<=new Date(x)?b.insuredDate.minDate:x,b.insuredDate={maxDate:w,minDate:x}}});var i=b.getCurrentTime(b.getServiceTime(!0));b.dateDifference(b.insuredDate.maxDate,i)<0&&(b.insuredDate.maxDate=i),b.date.maxDate=b.insuredDate.maxDate,b.date.minDate=b.insuredDate.minDate,b.defaultRestrict(),b.logRed("被保人日期："+b.insuredDate.minDate+"——"+b.insuredDate.maxDate)},setInsureStartDate:function(a){var b=this;if(b.data.product.deadline){var c=new Date;try{var d=parseInt(b.data.product.deadline.split(":")[0]),e=parseInt(b.data.product.deadline.split(":")[1]),f=new Date(c.getFullYear(),c.getMonth(),c.getDate(),d,e);c.getTime()-f.getTime()>0&&(b.firstDate=b.firstDate+1)}catch(g){}}if(b.data.product.nextDayDeadline){var c=b.getServiceTime(!0);try{var h=parseInt(b.data.product.nextDayDeadline.split(":")[0]),i=parseInt(b.data.product.nextDayDeadline.split(":")[1]),j=new Date(c.getFullYear(),c.getMonth(),c.getDate(),h,i);c.getTime()-j.getTime()>0&&(b.firstDate=b.firstDate+1)}catch(g){}}var k=b.createDate({date:b.firstDate}),l=b.createDate({date:b.latestDate});if(2===b.product.insureTime){var m=b.getCurrentTime(b.getDateFormat(b.fixedDate));k=l=m;var n=b.getCurrentTime(b.getDateFormat(b.product.fixedLatestDate)),o=b.getCurrentTime();b.dateDifference(n,o)>=0&&(l=this.createDate({newDate:l,date:-1}))}b.startDate={maxDate:l,minDate:k},b.logRed("起保日期："+b.startDate.minDate+"——"+b.startDate.maxDate)},showInsurantDateLimit:function(a){var b=this,c=$("#insurantDate"),d=$(a).val(),e=b.insurantDateLimit||"",f=e.indexOf("年"),g=e.indexOf("月"),h=e.indexOf("天"),i=e.indexOf("终身"),j="",k="",l="",m=[];b.getDateFormat(b.fixedDate);if(d){if(d===b.getCurrentTime())m.push("如果您选择当日生效，请务必于当日"+b.replaceNull(b.data.product.deadline)+"前完成支付，以确保电子保单的顺利生成。");else if(-1!==i)m.push("保险期限为终身，具体详情以保单为准（起保时间："+d+"）");else if(b.flightNumber)m.push("保险期间，由被保险人进入机舱起到出机舱结束（起保时间："+d+"）");else{if(j='自<span class="insure-bold">'+d+"零时</span>起 ",b.insurantDateLimit){var n=new Date(b.compatibleDateFormat(d)),o=n.getFullYear(),p=n.getMonth(),q=b.product.calculateType;if(-1!==e.indexOf("-")&&(e=e.split("-")[1]),-1!==f){var r=parseInt(e,10);q?n.setDate(n.getDate()+365*r-1):(n.setYear(o+r),n.setDate(n.getDate()-1)),e=b.getCurrentTime(n),k='至<span class="insure-bold">'+e+"二十四时止</span>（北京时间）"}else if(-1!==g){var s=parseInt(e,10);q?n.setDate(n.getDate()+30*s-1):(n.setMonth(p+s),n.setDate(n.getDate()-1),n.getMonth()-p+12*(n.getFullYear()-o)>s&&n.setDate(0)),e=b.getCurrentTime(n),k='至<span class="insure-bold">'+e+"二十四时止</span>（北京时间）"}else if(-1!==h){var t=parseInt(e,10);n.setDate(n.getDate()+t-1),e=b.getCurrentTime(n),k='至<span class="insure-bold">'+e+"二十四时止</span>（北京时间）"}else e=b.insurantDateLimit,k='<span class="insure-bold">保障'+e+"</span>"}else b.isInsurantDate&&(e=b.isInsurantDate,k='至<span class="insure-bold">'+e+"</span>二十四时止（北京时间"+l+"）");m.push(j+k)}c.html(m.join(""))}},getDefaultStartMinDate:function(a,b){var c="";return this.MODULES_ID_INSURE_DATE===a&&this.ATTR_ID_INSURE_DATE===b&&this.dateDifference(this.startDate.minDate,this.startDate.maxDate)>=0&&(c=this.startDate.minDate),c},getMaxDate:function(a,b){var c=this,d=c.getCurrentTime();return a===c.MODULES_ID_INSURE&&b===c.ATTR_ID_BIRTHDATE?(d=c.insureDate.maxDate,c.isSelf&&(d=c.dateDifference(c.insureDate.maxDate,c.insuredDate.maxDate)>=0?c.insureDate.maxDate:c.insuredDate.maxDate)):a===c.MODULES_ID_INSURED&&b===c.ATTR_ID_BIRTHDATE?d=c.insuredDate.maxDate:c.MODULES_ID_INSURE_DATE===a&&c.ATTR_ID_INSURE_DATE===b?d=c.startDate.maxDate:c.ATTR_ID_CREDENTIALSVALIDITY===b,d},getMinDate:function(a,b){var c=this,d="1900-1-1";return a===c.MODULES_ID_INSURE&&b===c.ATTR_ID_BIRTHDATE?(d=c.insureDate.minDate,c.isSelf&&(d=c.dateDifference(c.insureDate.minDate,c.insuredDate.minDate)>=0?c.insuredDate.minDate:c.insureDate.minDate)):a===c.MODULES_ID_INSURED&&b===c.ATTR_ID_BIRTHDATE?d=c.insuredDate.minDate:c.MODULES_ID_INSURE_DATE===a&&c.ATTR_ID_INSURE_DATE===b?d=c.startDate.minDate:c.ATTR_ID_CREDENTIALSVALIDITY===b,d},credentialsValidity:function(a){var b=($(a).data("moduleid"),$(a).parents("dd").find(".validity-span")),c=b.nextAll(".insure-tips");$(a).is(":checked")?(b.hide().attr("disabled",!0),c.hide(),$(a).val(1)):(b.show().attr("disabled",!1),c.show(),$(a).val(0))}},b});